<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="description" content="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ–Ω–ª–∞–π–Ω: –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (—Å—Ç—Ä–µ–ª–∫–∏, –±–ª–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, numpad), —Ç–µ—Å—Ç ghosting/rollover, –∏—Å—Ç–æ—Ä–∏—è, —ç–∫—Å–ø–æ—Ä—Ç. –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ." />
  <meta name="theme-color" content="#0b0b12" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Keyboard Tester</title>

  <style>
    :root{
      --bg:#070710;
      --bg2:#0a0a14;
      --card:#101024;
      --card2:#121235;
      --text:#f3f4ff;
      --muted:#a7aac7;
      --muted2:#7c80a6;
      --border:rgba(255,255,255,.11);
      --border2:rgba(255,255,255,.07);
      --shadow:0 30px 90px rgba(0,0,0,.62);
      --radius:18px;
      --radius2:14px;

      --accent:#6c5ce7;
      --accent2:#a29bff;
      --good:#55efc4;
      --warn:#ffeaa7;
      --bad:#ff7675;

      --kbd:#0e0f1d;
      --kbd2:#12142b;
      --kbdText:#ececff;
      --kbdMuted:#b7bbdf;
      --kbdBorder:rgba(255,255,255,.10);

      --pressBg:rgba(108,92,231,.18);
      --pressBorder:rgba(162,155,255,.85);
      --pressGlow:0 16px 40px rgba(108,92,231,.28);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    [data-theme="light"]{
      --bg:#f6f7ff;
      --bg2:#eef1ff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#0b0b13;
      --muted:#48506a;
      --muted2:#5b6282;
      --border:rgba(10,10,20,.14);
      --border2:rgba(10,10,20,.10);
      --shadow:0 18px 60px rgba(18,22,60,.16);

      --kbd:#f3f5ff;
      --kbd2:#edf0ff;
      --kbdText:#0b0b13;
      --kbdMuted:#404862;
      --kbdBorder:rgba(10,10,20,.14);

      --pressBg:rgba(108,92,231,.14);
      --pressBorder:rgba(108,92,231,.60);
      --pressGlow:0 14px 34px rgba(108,92,231,.18);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(108,92,231,.26), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(162,155,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding: 22px;
    }
    a{color:var(--accent2);text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      max-width: 1280px;
      margin:0 auto;
      display:grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr);
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1080px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent 45%), var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 280px;
    }
    .logo{
      width: 42px; height: 42px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 30% 20%, rgba(162,155,255,.35), rgba(108,92,231,.22) 45%, rgba(0,0,0,.12) 80%),
        rgba(108,92,231,.10);
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      letter-spacing:.02em;
      user-select:none;
    }
    .title h1{
      font-size: 18px;
      font-weight: 820;
      letter-spacing: .02em;
    }
    .title p{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 3px;
      line-height:1.35;
      max-width: 620px;
    }

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:var(--border)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn.primary{
      background: linear-gradient(90deg, rgba(108,92,231,.25), rgba(162,155,255,.18));
      border-color: rgba(162,155,255,.38);
    }
    .chip{
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid var(--border2);
      color: var(--muted);
      display:inline-flex;gap:7px;align-items:center;
      background: rgba(0,0,0,.12);
      user-select:none;
    }
    [data-theme="light"] .chip{background: rgba(10,10,20,.03)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 12px rgba(85,239,196,.55)}
    .dot.warn{background:var(--warn);box-shadow:0 0 12px rgba(255,234,167,.45)}

    .inner{padding: 14px 16px 16px}

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.25fr);
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border2);
      background: rgba(0,0,0,.12);
      border-radius: var(--radius2);
      padding: 12px;
    }
    [data-theme="light"] .panel{background: rgba(10,10,20,.03)}

    .sectionTitle{
      font-size: 12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .hero{
      border:1px solid var(--border2);
      border-radius: 16px;
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,.05), transparent 55%),
        rgba(0,0,0,.18);
      padding: 14px;
      overflow:hidden;
    }
    [data-theme="light"] .hero{background: radial-gradient(circle at 20% 10%, rgba(10,10,20,.03), transparent 55%), rgba(10,10,20,.02)}

    .bigTop{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-bottom: 10px;
    }
    .cap{
      min-width: 180px;
      min-height: 72px;
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      box-shadow: 0 20px 55px rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 34px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      user-select:none;
    }
    [data-theme="light"] .cap{background: rgba(10,10,20,.04);box-shadow: 0 18px 42px rgba(18,22,60,.12)}
    .cap.small{
      font-size: 16px;
      letter-spacing:.02em;
      text-transform:none;
      color: var(--muted);
      font-weight: 720;
    }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    @media (max-width: 520px){ .meta{grid-template-columns:1fr} }
    .metaRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      align-items:center;
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      max-width: 62%;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    .mods{
      display:flex; flex-wrap:wrap; gap:6px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
      margin-top: 12px;
    }
    .miniKey{
      font-family: var(--mono);
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 10px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--kbdMuted);
      transition: all .12s ease;
      user-select:none;
    }
    .miniKey.on{
      border-color: var(--pressBorder);
      background: var(--pressBg);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(162,155,255,.26);
    }

    /* Keyboard */
    .kbShell{
      border:1px solid var(--border2);
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      padding: 12px;
      overflow:auto;
    }
    [data-theme="light"] .kbShell{background: rgba(10,10,20,.02)}
    .kbTop{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom: 10px;
    }
    .hint{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hint b{color: var(--text)}
    .kbdGrid{
      display:grid;
      gap: 10px;
      min-width: 1060px; /* ensures full layout fits with scroll if needed */
    }

    .row{display:grid;gap:8px}
    .key{
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 52%), var(--kbd);
      border: 1px solid var(--kbdBorder);
      color: var(--kbdText);
      display:flex;align-items:center;justify-content:center;
      font-size: 12px;
      font-family: var(--mono);
      position:relative;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease;
      min-width: 44px;
    }
    [data-theme="light"] .key{
      background: linear-gradient(180deg, rgba(10,10,20,.03), transparent 52%), var(--kbd);
    }
    .key .sub{
      position:absolute;
      right: 8px;
      bottom: 6px;
      font-size: 10px;
      color: var(--kbdMuted);
      opacity: .90;
    }
    .key.pressed{
      background: linear-gradient(180deg, rgba(162,155,255,.22), rgba(108,92,231,.14)), var(--kbd2);
      border-color: var(--pressBorder);
      box-shadow: var(--pressGlow);
      transform: translateY(-1px);
    }
    .key.sticky{
      outline: 2px solid rgba(255,234,167,.35);
      box-shadow: 0 0 0 1px rgba(255,234,167,.25), var(--pressGlow);
    }

    /* Layout: full-size ANSI + nav cluster + arrows + numpad */
    .rFn{ grid-template-columns: repeat(4, 1fr) 0.5fr repeat(4,1fr) 0.5fr repeat(4,1fr) 0.5fr repeat(3,1fr); }
    .r1 { grid-template-columns: repeat(14, 1fr) 0.5fr repeat(3,1fr) 0.5fr repeat(4,1fr); }
    .r2 { grid-template-columns: 1.5fr repeat(12, 1fr) 2.2fr 0.5fr 1fr 1fr 1fr 0.5fr 1fr 1fr 1fr 1fr; }
    .r3 { grid-template-columns: 2.1fr repeat(12, 1fr) 2.7fr 0.5fr 1fr 1fr 1fr 0.5fr 1fr 1fr 1fr 1fr; }
    .r4 { grid-template-columns: 2.6fr repeat(11, 1fr) 3.2fr 0.5fr 1fr 1fr 1fr 0.5fr 1fr 1fr 1fr 1fr; }
    .r5 { grid-template-columns: 3.2fr repeat(10, 1fr) 3.8fr 0.5fr 1fr 1fr 1fr 0.5fr 1fr 1fr 1fr 1fr; }
    .r6 { grid-template-columns: 1.8fr 1.4fr 1.4fr 7.0fr 1.4fr 1.4fr 1.4fr 0.5fr 1.2fr 1.2fr 1.2fr 0.5fr 2.2fr 1fr 1fr 1fr; }
    /* Arrows row is included via r6 (cluster) */

    .log{
      max-height: 240px;
      overflow:auto;
      border:1px dashed var(--border2);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,.14);
    }
    [data-theme="light"] .log{background: rgba(10,10,20,.02)}
    .logRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.04);
    }
    [data-theme="light"] .logRow{border-bottom: 1px solid rgba(10,10,20,.06)}
    .logRow:last-child{border-bottom:none}
    .logLeft{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.03);
    }
    .logMeta{font-size: 11px;color: var(--muted);white-space:nowrap}
    .empty{font-size: 13px;color: var(--muted);padding: 6px 2px}
    .footer{
      margin-top: 10px;
      font-size: 11.5px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .statGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.statGrid{grid-template-columns:1fr}}
    .stat{
      border:1px solid var(--border2);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    .stat .n{font-size: 22px;font-weight: 900}
    .stat .t{font-size: 12px;color: var(--muted);margin-top: 2px}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      display:none;
      gap: 8px;
      align-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      z-index: 99;
    }
    [data-theme="light"] .toast{background: rgba(10,10,20,.78)}
    .toast.show{display:inline-flex;animation: pop .18s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}

    .sr{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- MAIN -->
    <section class="card" id="main" tabindex="0" aria-label="Keyboard tester">
      <div class="header">
        <div class="brand">
          <div class="logo">K</div>
          <div class="title">
            <h1 id="uiTitle">–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</h1>
            <p id="uiSub">–í–∏–∑—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (—Å—Ç—Ä–µ–ª–∫–∏ + numpad), –∏—Å—Ç–æ—Ä–∏—è, —ç–∫—Å–ø–æ—Ä—Ç, ghosting/rollover —Ç–µ—Å—Ç. –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
          </div>
        </div>

        <div class="controls">
          <span class="chip" title="–°—Ç–∞—Ç—É—Å">
            <span class="dot" id="dot"></span>
            <span id="uiLive">Live</span>
          </span>

          <button class="btn primary" id="btnInstall" style="display:none;">‚¨áÔ∏è <span id="uiInstall">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span></button>
          <button class="btn primary" id="btnCapture"><span id="uiCapture">Capture: ON</span></button>

          <button class="btn" id="btnLang" title="Language">RU</button>
          <button class="btn" id="btnTheme" title="Theme">üåô</button>

          <button class="btn" id="btnShare">üîó <span id="uiShare">–°—Å—ã–ª–∫–∞</span></button>
        </div>
      </div>

      <div class="inner">
        <div class="grid">
          <!-- LEFT -->
          <div class="hero">
            <div class="bigTop">
              <div>
                <div class="sectionTitle"><span id="uiCurrent">–¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏—à–∞</span></div>
                <div class="cap small" id="cap">–ù–∞–∂–º–∏ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É</div>
              </div>

              <div class="panel" style="min-width:300px;max-width:420px;">
                <div class="sectionTitle">
                  <span id="uiHowFast">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span>
                  <span class="chip" title="Focus">
                    <span class="dot warn" id="focusDot"></span>
                    <span id="uiFocus">–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å</span>
                  </span>
                </div>
                <div class="hint" id="uiHint">
                  –ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∏ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏ ‚Äî —Å–ø—Ä–∞–≤–∞ –±—É–¥–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∞.
                  –î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π —É–¥–µ—Ä–∂–∏–≤–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫.
                  –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –º–µ—à–∞–µ—Ç —Ö–æ—Ç–∫–µ—è–º–∏ ‚Äî –≤–∫–ª—é—á–∏ <b>Capture Mode</b>.
                </div>
              </div>
            </div>

            <div class="meta">
              <div class="metaRow"><span>event.key</span><span class="badge" id="mKey">‚Äî</span></div>
              <div class="metaRow"><span>event.code</span><span class="badge" id="mCode">‚Äî</span></div>
              <div class="metaRow"><span>keyCode</span><span class="badge" id="mKeyCode">‚Äî</span></div>
              <div class="metaRow"><span id="uiLoc">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span><span class="badge" id="mLoc">‚Äî</span></div>
            </div>

            <div class="mods">
              <span id="uiMods">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</span>
              <span class="miniKey" id="modCtrl">Ctrl</span>
              <span class="miniKey" id="modAlt">Alt</span>
              <span class="miniKey" id="modShift">Shift</span>
              <span class="miniKey" id="modMeta">Win/‚åò</span>
              <span class="miniKey" id="modCaps">Caps</span>
              <span class="miniKey" id="modNum">Num</span>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="sectionTitle">
                <span id="uiPressed">–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã</span>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn" id="btnReset"><span id="uiReset">–°–±—Ä–æ—Å</span></button>
                </div>
              </div>
              <div class="hint" id="pressedNow">‚Äî</div>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="sectionTitle"><span id="uiGhost">Rollover / Ghosting —Ç–µ—Å—Ç</span></div>
              <div class="statGrid">
                <div class="stat">
                  <div class="n" id="simNow">0</div>
                  <div class="t" id="uiSimNow">–°–µ–π—á–∞—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</div>
                </div>
                <div class="stat">
                  <div class="n" id="simMax">0</div>
                  <div class="t" id="uiSimMax">–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–µ—Å—Å–∏—é</div>
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="hint" id="uiGhostHint">
                –ó–∞–∂–º–∏ 6‚Äì10 –∫–ª–∞–≤–∏—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, ASDFJKL;) –∏ —Å–º–æ—Ç—Ä–∏ —Å—á—ë—Ç—á–∏–∫.  
                –ï—Å–ª–∏ —á–∞—Å—Ç—å –∫–ª–∞–≤–∏—à ¬´–Ω–µ –∑–∞–∂–∏–º–∞–µ—Ç—Å—è¬ª ‚Äî —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ghosting).
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <div class="kbShell">
              <div class="kbTop">
                <div>
                  <div class="sectionTitle"><span id="uiVisual">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞</span></div>
                  <div class="hint" id="uiVisualHint">
                    –ü–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è. –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —É–¥–æ–±–Ω–µ–µ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ <b>event.code</b> ‚Äî —ç—Ç–æ ‚Äú—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è‚Äù –∫–ª–∞–≤–∏—à–∞.
                  </div>
                </div>
                <span class="chip" title="Privacy"><span class="dot" style="background:var(--accent2);box-shadow:0 0 12px rgba(162,155,255,.35)"></span><span id="uiPrivacy">–ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</span></span>
              </div>

              <div class="kbdGrid" id="kbd">
                <!-- Function row -->
                <div class="row rFn">
                  <div class="key" data-code="Escape">Esc</div>
                  <div class="key" data-code="F1">F1</div>
                  <div class="key" data-code="F2">F2</div>
                  <div class="key" data-code="F3">F3</div>
                  <div></div>
                  <div class="key" data-code="F4">F4</div>
                  <div class="key" data-code="F5">F5</div>
                  <div class="key" data-code="F6">F6</div>
                  <div class="key" data-code="F7">F7</div>
                  <div></div>
                  <div class="key" data-code="F8">F8</div>
                  <div class="key" data-code="F9">F9</div>
                  <div class="key" data-code="F10">F10</div>
                  <div class="key" data-code="F11">F11</div>
                  <div></div>
                  <div class="key" data-code="F12">F12</div>
                  <div class="key" data-code="PrintScreen">PrtSc</div>
                  <div class="key" data-code="ScrollLock">ScrLk</div>
                  <div class="key" data-code="Pause">Pause</div>
                </div>

                <!-- Row 1 -->
                <div class="row r1">
                  <div class="key" data-code="Backquote">`<div class="sub">~</div></div>
                  <div class="key" data-code="Digit1">1<div class="sub">!</div></div>
                  <div class="key" data-code="Digit2">2<div class="sub">@</div></div>
                  <div class="key" data-code="Digit3">3<div class="sub">#</div></div>
                  <div class="key" data-code="Digit4">4<div class="sub">$</div></div>
                  <div class="key" data-code="Digit5">5<div class="sub">%</div></div>
                  <div class="key" data-code="Digit6">6<div class="sub">^</div></div>
                  <div class="key" data-code="Digit7">7<div class="sub">&</div></div>
                  <div class="key" data-code="Digit8">8<div class="sub">*</div></div>
                  <div class="key" data-code="Digit9">9<div class="sub">(</div></div>
                  <div class="key" data-code="Digit0">0<div class="sub">)</div></div>
                  <div class="key" data-code="Minus">-<div class="sub">_</div></div>
                  <div class="key" data-code="Equal">=<div class="sub">+</div></div>
                  <div class="key" data-code="Backspace">Backspace</div>
                  <div></div>
                  <!-- Nav cluster -->
                  <div class="key" data-code="Insert">Ins</div>
                  <div class="key" data-code="Home">Home</div>
                  <div class="key" data-code="PageUp">PgUp</div>
                  <div></div>
                  <!-- Numpad top -->
                  <div class="key" data-code="NumLock">Num</div>
                  <div class="key" data-code="NumpadDivide">/</div>
                  <div class="key" data-code="NumpadMultiply">*</div>
                  <div class="key" data-code="NumpadSubtract">-</div>
                </div>

                <!-- Row 2 -->
                <div class="row r2">
                  <div class="key" data-code="Tab">Tab</div>
                  <div class="key" data-code="KeyQ">Q</div>
                  <div class="key" data-code="KeyW">W</div>
                  <div class="key" data-code="KeyE">E</div>
                  <div class="key" data-code="KeyR">R</div>
                  <div class="key" data-code="KeyT">T</div>
                  <div class="key" data-code="KeyY">Y</div>
                  <div class="key" data-code="KeyU">U</div>
                  <div class="key" data-code="KeyI">I</div>
                  <div class="key" data-code="KeyO">O</div>
                  <div class="key" data-code="KeyP">P</div>
                  <div class="key" data-code="BracketLeft">[<div class="sub">{</div></div>
                  <div class="key" data-code="BracketRight">]<div class="sub">}</div></div>
                  <div class="key" data-code="Backslash">\ <div class="sub">|</div></div>
                  <div></div>
                  <div class="key" data-code="Delete">Del</div>
                  <div class="key" data-code="End">End</div>
                  <div class="key" data-code="PageDown">PgDn</div>
                  <div></div>
                  <div class="key" data-code="Numpad7">7<div class="sub">Home</div></div>
                  <div class="key" data-code="Numpad8">8<div class="sub">‚Üë</div></div>
                  <div class="key" data-code="Numpad9">9<div class="sub">PgUp</div></div>
                  <div class="key" data-code="NumpadAdd">+</div>
                </div>

                <!-- Row 3 -->
                <div class="row r3">
                  <div class="key" data-code="CapsLock">Caps</div>
                  <div class="key" data-code="KeyA">A</div>
                  <div class="key" data-code="KeyS">S</div>
                  <div class="key" data-code="KeyD">D</div>
                  <div class="key" data-code="KeyF">F</div>
                  <div class="key" data-code="KeyG">G</div>
                  <div class="key" data-code="KeyH">H</div>
                  <div class="key" data-code="KeyJ">J</div>
                  <div class="key" data-code="KeyK">K</div>
                  <div class="key" data-code="KeyL">L</div>
                  <div class="key" data-code="Semicolon">;<div class="sub">:</div></div>
                  <div class="key" data-code="Quote">'<div class="sub">"</div></div>
                  <div class="key" data-code="Enter">Enter</div>
                  <div></div>
                  <div></div><div></div><div></div>
                  <div></div>
                  <div class="key" data-code="Numpad4">4<div class="sub">‚Üê</div></div>
                  <div class="key" data-code="Numpad5">5</div>
                  <div class="key" data-code="Numpad6">6<div class="sub">‚Üí</div></div>
                  <div class="key" data-code="NumpadAdd">+</div>
                </div>

                <!-- Row 4 -->
                <div class="row r4">
                  <div class="key" data-code="ShiftLeft">Shift</div>
                  <div class="key" data-code="KeyZ">Z</div>
                  <div class="key" data-code="KeyX">X</div>
                  <div class="key" data-code="KeyC">C</div>
                  <div class="key" data-code="KeyV">V</div>
                  <div class="key" data-code="KeyB">B</div>
                  <div class="key" data-code="KeyN">N</div>
                  <div class="key" data-code="KeyM">M</div>
                  <div class="key" data-code="Comma">,<div class="sub">&lt;</div></div>
                  <div class="key" data-code="Period">.<div class="sub">&gt;</div></div>
                  <div class="key" data-code="Slash">/<div class="sub">?</div></div>
                  <div class="key" data-code="ShiftRight">Shift</div>
                  <div></div>
                  <div></div>
                  <div></div><div></div><div></div>
                  <div></div>
                  <div class="key" data-code="Numpad1">1<div class="sub">End</div></div>
                  <div class="key" data-code="Numpad2">2<div class="sub">‚Üì</div></div>
                  <div class="key" data-code="Numpad3">3<div class="sub">PgDn</div></div>
                  <div class="key" data-code="NumpadEnter">Enter</div>
                </div>

                <!-- Row 5 (bottom) -->
                <div class="row r6">
                  <div class="key" data-code="ControlLeft">Ctrl</div>
                  <div class="key" data-code="MetaLeft">Win</div>
                  <div class="key" data-code="AltLeft">Alt</div>
                  <div class="key" data-code="Space">Space</div>
                  <div class="key" data-code="AltRight">Alt</div>
                  <div class="key" data-code="MetaRight">Win</div>
                  <div class="key" data-code="ContextMenu">Menu</div>

                  <div></div>

                  <!-- arrows cluster -->
                  <div class="key" data-code="ArrowLeft">‚Üê</div>
                  <div class="key" data-code="ArrowDown">‚Üì</div>
                  <div class="key" data-code="ArrowRight">‚Üí</div>

                  <div></div>

                  <!-- numpad bottom -->
                  <div class="key" data-code="Numpad0">0</div>
                  <div class="key" data-code="NumpadDecimal">.</div>
                  <div class="key" data-code="NumpadEnter">Enter</div>
                  <div class="key" data-code="ControlRight">Ctrl</div>
                </div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="panel">
              <div class="sectionTitle">
                <span id="uiHistory">–ò—Å—Ç–æ—Ä–∏—è</span>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn" id="btnCopy"><span id="uiCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span></button>
                  <button class="btn" id="btnCSV"><span id="uiCSV">–≠–∫—Å–ø–æ—Ä—Ç CSV</span></button>
                  <button class="btn" id="btnClear"><span id="uiClear">–û—á–∏—Å—Ç–∏—Ç—å</span></button>
                </div>
              </div>

              <div class="log" id="log"><div class="empty" id="logEmpty">–°–¥–µ–ª–∞–π –ø–∞—Ä—É –Ω–∞–∂–∞—Ç–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div></div>

              <div class="footer">
                <span id="uiFooter">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</span>
                <span><a href="#" id="focusLink">Focus</a> ¬∑ <a href="#" id="topLink">Top</a></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SIDE -->
    <aside class="card">
      <div class="inner">
        <div class="sectionTitle"><span id="uiSideTitle">–°–¥–µ–ª–∞–Ω–æ –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç</span></div>
        <div class="hint" id="uiSideText">
          <b>1)</b> –í–∫–ª—é—á–∏ —Ñ–æ–∫—É—Å (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ).<br/>
          <b>2)</b> –ü—Ä–æ–≤–µ—Ä—å –≤—Å–µ –∫–ª–∞–≤–∏—à–∏ ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ª–æ–≤–∏—Ç –±—Ä–∞—É–∑–µ—Ä.<br/>
          <b>3)</b> –î–ª—è –∏–≥—Ä —Å–º–æ—Ç—Ä–∏ <b>event.code</b> ‚Äî —ç—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏—à–∞, –Ω–µ —Å–∏–º–≤–æ–ª.<br/>
          <b>4)</b> –î–ª—è ghosting –∑–∞–∂–∏–º–∞–π –º–Ω–æ–≥–æ –∫–ª–∞–≤–∏—à —Å—Ä–∞–∑—É –∏ —Å–º–æ—Ç—Ä–∏ –º–∞–∫—Å–∏–º—É–º.
        </div>

        <div style="height:14px"></div>

        <div class="panel">
          <div class="sectionTitle"><span id="uiPro">–§–∏—à–∫–∏</span></div>
          <div class="hint" id="uiProText">
            ‚Ä¢ –ü–æ–ª–Ω—ã–π layout: —Å—Ç—Ä–µ–ª–∫–∏ + –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ + numpad<br/>
            ‚Ä¢ Capture Mode (–º–µ–Ω—å—à–µ –º–µ—à–∞—é—Ç —Ö–æ—Ç–∫–µ–∏/–ø—Ä–æ–∫—Ä—É—Ç–∫–∞)<br/>
            ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç CSV –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏<br/>
            ‚Ä¢ PWA: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="panel">
          <div class="sectionTitle"><span id="uiBrand">–ë—Ä–µ–Ω–¥–∏–Ω–≥</span></div>
          <div class="hint">
            –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –¥–æ–±–∞–≤–∏–º –ª–æ–≥–æ—Ç–∏–ø, –∏–∫–æ–Ω–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–π –¥–æ–º–µ–Ω –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É /about.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span>‚úÖ</span><span id="toastText">–ì–æ—Ç–æ–≤–æ</span>
  </div>
  <div class="sr" id="sr" aria-live="polite"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const main = $("main");
  const cap = $("cap");
  const mKey = $("mKey");
  const mCode = $("mCode");
  const mKeyCode = $("mKeyCode");
  const mLoc = $("mLoc");

  const modCtrl = $("modCtrl");
  const modAlt = $("modAlt");
  const modShift = $("modShift");
  const modMeta = $("modMeta");
  const modCaps = $("modCaps");
  const modNum = $("modNum");

  const pressedNow = $("pressedNow");
  const simNow = $("simNow");
  const simMax = $("simMax");

  const btnReset = $("btnReset");
  const btnClear = $("btnClear");
  const btnCopy = $("btnCopy");
  const btnCSV = $("btnCSV");
  const btnShare = $("btnShare");
  const btnTheme = $("btnTheme");
  const btnLang = $("btnLang");
  const btnCapture = $("btnCapture");

  const dot = $("dot");
  const focusDot = $("focusDot");

  const btnInstall = $("btnInstall");

  const log = $("log");
  const logEmpty = $("logEmpty");

  const toast = $("toast");
  const toastText = $("toastText");
  const sr = $("sr");

  const focusLink = $("focusLink");
  const topLink = $("topLink");

  const keys = Array.from(document.querySelectorAll("[data-code]"));
  const keyByCode = new Map(keys.map(k => [k.dataset.code, k]));

  // State
  let captureMode = true;
  let maxSim = 0;
  let lang = localStorage.getItem("kb_lang") || "ru";
  let theme = localStorage.getItem("kb_theme") || "dark";

  const pressed = new Set(); // store code strings
  const sticky = new Set();  // "stuck" detector if no keyup received
  const logData = [];
  const LOG_LIMIT = 45;

  const i18n = {
    ru: {
      title: "–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã",
      sub: "–í–∏–∑—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (—Å—Ç—Ä–µ–ª–∫–∏ + numpad), –∏—Å—Ç–æ—Ä–∏—è, —ç–∫—Å–ø–æ—Ä—Ç, ghosting/rollover —Ç–µ—Å—Ç. –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.",
      live: "Live",
      install: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
      captureOn: "Capture: ON",
      captureOff: "Capture: OFF",
      share: "–°—Å—ã–ª–∫–∞",
      current: "–¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏—à–∞",
      howFast: "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è",
      focus: "–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å",
      hint: "–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∏ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏ ‚Äî —Å–ø—Ä–∞–≤–∞ –±—É–¥–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∞. –î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π —É–¥–µ—Ä–∂–∏–≤–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫. –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –º–µ—à–∞–µ—Ç —Ö–æ—Ç–∫–µ—è–º–∏ ‚Äî –≤–∫–ª—é—á–∏ <b>Capture Mode</b>.",
      loc: "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
      mods: "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:",
      pressed: "–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã",
      reset: "–°–±—Ä–æ—Å",
      ghost: "Rollover / Ghosting —Ç–µ—Å—Ç",
      simNow: "–°–µ–π—á–∞—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
      simMax: "–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–µ—Å—Å–∏—é",
      ghostHint: "–ó–∞–∂–º–∏ 6‚Äì10 –∫–ª–∞–≤–∏—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, ASDFJKL;) –∏ —Å–º–æ—Ç—Ä–∏ —Å—á—ë—Ç—á–∏–∫. –ï—Å–ª–∏ —á–∞—Å—Ç—å –∫–ª–∞–≤–∏—à ¬´–Ω–µ –∑–∞–∂–∏–º–∞–µ—Ç—Å—è¬ª ‚Äî —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ghosting).",
      visual: "–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
      visualHint: "–ü–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è. –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —É–¥–æ–±–Ω–µ–µ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ <b>event.code</b> ‚Äî —ç—Ç–æ ‚Äú—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è‚Äù –∫–ª–∞–≤–∏—à–∞.",
      privacy: "–ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞",
      history: "–ò—Å—Ç–æ—Ä–∏—è",
      copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      csv: "–≠–∫—Å–ø–æ—Ä—Ç CSV",
      clear: "–û—á–∏—Å—Ç–∏—Ç—å",
      empty: "–°–¥–µ–ª–∞–π –ø–∞—Ä—É –Ω–∞–∂–∞—Ç–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.",
      footer: "–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.",
      sideTitle: "–°–¥–µ–ª–∞–Ω–æ –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç",
      sideText: "<b>1)</b> –í–∫–ª—é—á–∏ —Ñ–æ–∫—É—Å (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ).<br/><b>2)</b> –ü—Ä–æ–≤–µ—Ä—å –≤—Å–µ –∫–ª–∞–≤–∏—à–∏ ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ª–æ–≤–∏—Ç –±—Ä–∞—É–∑–µ—Ä.<br/><b>3)</b> –î–ª—è –∏–≥—Ä —Å–º–æ—Ç—Ä–∏ <b>event.code</b> ‚Äî —ç—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏—à–∞, –Ω–µ —Å–∏–º–≤–æ–ª.<br/><b>4)</b> –î–ª—è ghosting –∑–∞–∂–∏–º–∞–π –º–Ω–æ–≥–æ –∫–ª–∞–≤–∏—à —Å—Ä–∞–∑—É –∏ —Å–º–æ—Ç—Ä–∏ –º–∞–∫—Å–∏–º—É–º.",
      pro: "–§–∏—à–∫–∏",
      proText: "‚Ä¢ –ü–æ–ª–Ω—ã–π layout: —Å—Ç—Ä–µ–ª–∫–∏ + –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ + numpad<br/>‚Ä¢ Capture Mode (–º–µ–Ω—å—à–µ –º–µ—à–∞—é—Ç —Ö–æ—Ç–∫–µ–∏/–ø—Ä–æ–∫—Ä—É—Ç–∫–∞)<br/>‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç CSV –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏<br/>‚Ä¢ PWA: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
      toastCopied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ",
      toastLink: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ",
      toastCSV: "CSV —Å–∫–∞—á–∞–Ω ‚úÖ",
      toastCleared: "–û—á–∏—â–µ–Ω–æ ‚úÖ",
      toastReset: "–°–±—Ä–æ—à–µ–Ω–æ ‚úÖ",
      capEmpty: "–ù–∞–∂–º–∏ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É",
      locStd: "–û–±—ã—á–Ω–æ–µ",
      locL: "–õ–µ–≤–∞—è",
      locR: "–ü—Ä–∞–≤–∞—è",
      locN: "Numpad",
    },
    en: {
      title: "Keyboard Tester",
      sub: "Visual keyboard (arrows + numpad), history, export, and ghosting/rollover test. Runs locally in your browser.",
      live: "Live",
      install: "Install",
      captureOn: "Capture: ON",
      captureOff: "Capture: OFF",
      share: "Link",
      current: "Current key",
      howFast: "How to use",
      focus: "Need focus",
      hint: "Click the card and press keys ‚Äî the keyboard highlights them. Hold multiple keys for combos. If browser shortcuts interfere ‚Äî toggle <b>Capture Mode</b>.",
      loc: "Location",
      mods: "Modifiers:",
      pressed: "Pressed now",
      reset: "Reset",
      ghost: "Rollover / Ghosting test",
      simNow: "Simultaneous now",
      simMax: "Session max",
      ghostHint: "Hold 6‚Äì10 keys (e.g., ASDFJKL;) and watch the counter. Missing keys = ghosting/rollover limits.",
      visual: "Visual keyboard",
      visualHint: "Highlights real presses. For games, <b>event.code</b> is the physical key location.",
      privacy: "No server",
      history: "History",
      copy: "Copy",
      csv: "Export CSV",
      clear: "Clear",
      empty: "Press a few keys ‚Äî they will appear here.",
      footer: "Privacy: nothing is sent to a server.",
      sideTitle: "Built like a product",
      sideText: "<b>1)</b> Focus the tester (click the card).<br/><b>2)</b> Press keys ‚Äî highlights show what the browser receives.<br/><b>3)</b> For games, use <b>event.code</b> (physical key).<br/><b>4)</b> For ghosting, hold many keys and watch the max.",
      pro: "Features",
      proText: "‚Ä¢ Full layout: arrows + nav cluster + numpad<br/>‚Ä¢ Capture Mode (less scrolling/shortcuts issues)<br/>‚Ä¢ CSV export & copy history<br/>‚Ä¢ PWA installable app",
      toastCopied: "Copied ‚úÖ",
      toastLink: "Link copied ‚úÖ",
      toastCSV: "CSV downloaded ‚úÖ",
      toastCleared: "Cleared ‚úÖ",
      toastReset: "Reset ‚úÖ",
      capEmpty: "Press any key",
      locStd: "Standard",
      locL: "Left",
      locR: "Right",
      locN: "Numpad",
    }
  };

  function setText(id, v){ const el = $(id); if(el) el.textContent = v; }
  function setHTML(id, v){ const el = $(id); if(el) el.innerHTML = v; }

  function toastShow(text){
    toastText.textContent = text;
    toast.classList.add("show");
    sr.textContent = text;
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
  }

  function applyTheme(){
    document.documentElement.setAttribute("data-theme", theme);
    btnTheme.textContent = theme === "dark" ? "üåô" : "‚òÄÔ∏è";
    localStorage.setItem("kb_theme", theme);
  }

  function updateCapture(){
    setText("uiCapture", captureMode ? i18n[lang].captureOn : i18n[lang].captureOff);
    dot.style.opacity = captureMode ? "1" : ".75";
  }

  function locText(loc){
    const t = i18n[lang];
    if(loc === 1) return t.locL;
    if(loc === 2) return t.locR;
    if(loc === 3) return t.locN;
    return t.locStd;
  }

  function setFocusState(){
    const hasFocus = document.activeElement === main;
    focusDot.classList.toggle("warn", !hasFocus);
    setText("uiFocus", i18n[lang].focus);
  }

  function setMods(e){
    modCtrl.classList.toggle("on", !!e.ctrlKey);
    modAlt.classList.toggle("on", !!e.altKey);
    modShift.classList.toggle("on", !!e.shiftKey);
    modMeta.classList.toggle("on", !!e.metaKey);
    // Caps/Num are special: rely on getModifierState when available
    try{
      modCaps.classList.toggle("on", !!e.getModifierState && e.getModifierState("CapsLock"));
      modNum.classList.toggle("on", !!e.getModifierState && e.getModifierState("NumLock"));
    }catch{}
  }

  function highlight(code, on){
    const el = keyByCode.get(code);
    if(el) el.classList.toggle("pressed", on);
  }

  function setMain(e){
    const display = (e.key === " ") ? "Space" : e.key;
    cap.textContent = display;
    cap.classList.remove("small");
    mKey.textContent = String(e.key);
    mCode.textContent = String(e.code);
    mKeyCode.textContent = String(e.keyCode);
    mLoc.textContent = locText(e.location);
    setMods(e);
  }

  function updatePressedText(){
    if(!pressed.size){
      pressedNow.textContent = "‚Äî";
      simNow.textContent = "0";
      return;
    }
    const list = Array.from(pressed).sort();
    pressedNow.textContent = list.join(" + ");
    simNow.textContent = String(pressed.size);
    if(pressed.size > maxSim){
      maxSim = pressed.size;
      simMax.textContent = String(maxSim);
    }
  }

  function addLog(e){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    const time = `${hh}:${mm}:${ss}`;

    const item = {
      time,
      key: (e.key === " ") ? "Space" : e.key,
      code: e.code,
      keyCode: e.keyCode,
      mods: [
        e.ctrlKey ? "Ctrl" : null,
        e.altKey ? "Alt" : null,
        e.shiftKey ? "Shift" : null,
        e.metaKey ? "Win/‚åò" : null
      ].filter(Boolean).join(" + ") || "‚Äî",
      type: e.type
    };
    logData.unshift(item);
    if(logData.length > LOG_LIMIT) logData.length = LOG_LIMIT;
    renderLog();
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function renderLog(){
    if(!logData.length){
      log.innerHTML = `<div class="empty">${escapeHtml(i18n[lang].empty)}</div>`;
      return;
    }
    log.innerHTML = logData.map(x => `
      <div class="logRow">
        <div class="logLeft">
          <span class="pill">${escapeHtml(x.key)}</span>
          <span class="pill">${escapeHtml(x.code)}</span>
        </div>
        <div class="logMeta">${escapeHtml(x.time)} ¬∑ keyCode:${escapeHtml(String(x.keyCode))} ¬∑ ${escapeHtml(x.mods)}</div>
      </div>
    `).join("");
  }

  function maybePreventDefaults(e){
    if(!captureMode) return;

    // keep Ctrl/Meta shortcuts usable (refresh, new tab, etc.)
    if(e.ctrlKey || e.metaKey) return;

    const block = new Set([
      " ", "Spacebar",
      "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
      "PageUp","PageDown","Home","End"
    ]);
    if(block.has(e.key)) e.preventDefault();
    if(e.key === "Tab") e.preventDefault();
  }

  function onDown(e){
    setFocusState();
    if(document.activeElement !== main) return;

    maybePreventDefaults(e);
    setMain(e);

    const code = e.code || String(e.keyCode) || e.key;
    if(!pressed.has(code)){
      pressed.add(code);
      highlight(code, true);
      sticky.add(code);
      updatePressedText();
    }
    if(!e.repeat) addLog(e);
  }

  function onUp(e){
    if(document.activeElement !== main) return;

    const code = e.code || String(e.keyCode) || e.key;
    if(pressed.has(code)){
      pressed.delete(code);
      sticky.delete(code);
      highlight(code, false);
      updatePressedText();
    }
    setMods(e);
  }

  function resetAll(){
    for(const code of pressed) highlight(code, false);
    pressed.clear();
    sticky.clear();
    updatePressedText();
    cap.textContent = i18n[lang].capEmpty;
    cap.classList.add("small");
    mKey.textContent = "‚Äî";
    mCode.textContent = "‚Äî";
    mKeyCode.textContent = "‚Äî";
    mLoc.textContent = "‚Äî";
    modCtrl.classList.remove("on");
    modAlt.classList.remove("on");
    modShift.classList.remove("on");
    modMeta.classList.remove("on");
    modCaps.classList.remove("on");
    modNum.classList.remove("on");
    toastShow(i18n[lang].toastReset);
  }

  function copyText(txt){
    return navigator.clipboard.writeText(txt);
  }

  function exportCSV(){
    const rows = [["time","type","key","code","keyCode","mods"]];
    for(const x of logData.slice().reverse()){
      rows.push([x.time, x.type, x.key, x.code, String(x.keyCode), x.mods]);
    }
    const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "keyboard-history.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    toastShow(i18n[lang].toastCSV);
  }

  function applyLang(){
    const t = i18n[lang];
    setText("uiTitle", t.title);
    setText("uiSub", t.sub);
    setText("uiLive", t.live);
    setText("uiInstall", t.install);
    setText("uiShare", t.share);
    setText("uiCurrent", t.current);
    setText("uiHowFast", t.howFast);
    setHTML("uiHint", t.hint);
    setText("uiLoc", t.loc);
    setText("uiMods", t.mods);
    setText("uiPressed", t.pressed);
    setText("uiReset", t.reset);
    setText("uiGhost", t.ghost);
    setText("uiSimNow", t.simNow);
    setText("uiSimMax", t.simMax);
    setText("uiGhostHint", t.ghostHint);
    setText("uiVisual", t.visual);
    setHTML("uiVisualHint", t.visualHint);
    setText("uiPrivacy", t.privacy);
    setText("uiHistory", t.history);
    setText("uiCopy", t.copy);
    setText("uiCSV", t.csv);
    setText("uiClear", t.clear);
    setText("logEmpty", t.empty);
    setText("uiFooter", t.footer);
    setText("uiSideTitle", t.sideTitle);
    setHTML("uiSideText", t.sideText);
    setText("uiPro", t.pro);
    setHTML("uiProText", t.proText);

    btnLang.textContent = lang.toUpperCase();
    updateCapture();

    if(!pressed.size){
      cap.textContent = t.capEmpty;
      cap.classList.add("small");
    }
  }

  // UI
  btnTheme.addEventListener("click", () => {
    theme = (theme === "dark") ? "light" : "dark";
    applyTheme();
  });

  btnLang.addEventListener("click", () => {
    lang = (lang === "ru") ? "en" : "ru";
    localStorage.setItem("kb_lang", lang);
    applyLang();
    renderLog();
  });

  btnCapture.addEventListener("click", () => {
    captureMode = !captureMode;
    updateCapture();
  });

  btnReset.addEventListener("click", resetAll);

  btnClear.addEventListener("click", () => {
    logData.length = 0;
    renderLog();
    toastShow(i18n[lang].toastCleared);
  });

  btnCopy.addEventListener("click", async () => {
    const lines = logData.slice().reverse().map(x => `${x.time}\t${x.key}\t${x.code}\t${x.keyCode}\t${x.mods}`);
    const txt = lines.join("\n") || "";
    try{
      await copyText(txt);
      toastShow(i18n[lang].toastCopied);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toastShow(i18n[lang].toastCopied);
    }
  });

  btnCSV.addEventListener("click", exportCSV);

  btnShare.addEventListener("click", async () => {
    const url = location.href.split("#")[0];
    try{ await copyText(url); toastShow(i18n[lang].toastLink); }
    catch{ toastShow(url); }
  });

  focusLink.addEventListener("click",(e)=>{e.preventDefault(); main.focus({preventScroll:true});});
  topLink.addEventListener("click",(e)=>{e.preventDefault(); window.scrollTo({top:0,behavior:"smooth"});});

  main.addEventListener("click", ()=>main.focus({preventScroll:true}));

  // Sticky detector: if window loses focus, mark keys as sticky until reset
  window.addEventListener("blur", () => {
    // mark currently pressed as potentially sticky
    for(const code of pressed){
      const el = keyByCode.get(code);
      if(el) el.classList.add("sticky");
    }
  });
  window.addEventListener("focus", () => {
    // remove sticky outline when user continues (real keyup may never come)
    for(const code of sticky){
      const el = keyByCode.get(code);
      if(el) el.classList.remove("sticky");
    }
  });

  // Key listeners
  window.addEventListener("keydown", onDown, {passive:false});
  window.addEventListener("keyup", onUp);

  // Init
  applyTheme();
  applyLang();
  renderLog();
  main.focus({preventScroll:true});
  setFocusState();

  // Service Worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // PWA install
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.style.display = "inline-flex";
  });

  btnInstall.addEventListener("click", async () => {
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btnInstall.style.display = "none";
  });

})();
</script>
</body>
</html>

