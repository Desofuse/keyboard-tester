<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b14" />

  <title>–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ‚Äî Keyboard Tester</title>
  <meta name="description" content="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π, numpad, —Å—Ç—Ä–µ–ª–∫–∏, –∏—Å—Ç–æ—Ä–∏—è, —ç–∫—Å–ø–æ—Ä—Ç, rollover/ghosting. –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –æ—Ñ–ª–∞–π–Ω (PWA)." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- Icons (–µ—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –ª–µ–∂–∞—Ç –≤ –∫–æ—Ä–Ω–µ/–ø–∞–ø–∫–µ ‚Äî –æ—Å—Ç–∞–≤—å —Ç–∞–∫) -->
  <link rel="icon" href="favicon.ico" sizes="any" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root{
      --bg0:#070710;
      --bg1:#0b0b14;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.64);
      --muted2: rgba(255,255,255,.46);

      --accent: rgba(162,155,255,.85);
      --accent2: rgba(108,92,231,.60);
      --good: rgba(85,239,196,.85);

      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 16px 40px rgba(0,0,0,.40);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:var(--sans);
      background:
        radial-gradient(1000px 600px at 20% 12%, rgba(162,155,255,.22), transparent 60%),
        radial-gradient(900px 520px at 86% 30%, rgba(85,239,196,.12), transparent 60%),
        radial-gradient(800px 520px at 40% 95%, rgba(108,92,231,.10), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

  /* === FULLSCREEN KEYBOARD MODE === */

/* –û–±—â–∞—è —Å–µ—Ç–∫–∞: —É–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º 2 –∫–æ–ª–æ–Ω–∫–∏ */
.appGrid{
  grid-template-columns: 420px 1fr !important;
}

/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏/—Ñ–∏—à–∫–∏) ‚Äî –ø—Ä—è—á–µ–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
.rightCol{
  display: none !important;
}

/* –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–π —ç—Ç–∏ —Ç–æ–∂–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) */
.aside,
.sidebar,
.rightPanel,
.panelRight{
  display: none !important;
}


    /* Top bar */
    .top{
      position:sticky; top:0; z-index:5;
      background: linear-gradient(180deg, rgba(7,7,16,.92), rgba(7,7,16,.70));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topInner{
      max-width: 1280px;
      margin:0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      font-weight:900;
      letter-spacing:.5px;
    }
    .brandTxt{display:flex; flex-direction:column; gap:2px}
    .brandTxt b{font-size:14px; letter-spacing:.2px}
    .brandTxt span{font-size:12px; color:var(--muted)}
    .controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .pill:active{transform: translateY(1px)}
    .dot{
      width:8px; height:8px; border-radius:99px; background: var(--muted2);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.live{ background: var(--good); box-shadow: 0 0 0 4px rgba(85,239,196,.10), 0 0 18px rgba(85,239,196,.35);}
    .pillOn{
      border-color: rgba(162,155,255,.35);
      background: rgba(108,92,231,.16);
      box-shadow: 0 0 0 4px rgba(108,92,231,.08);
    }
    .ghostBtn{opacity:.9}

    /* Layout */
    .wrap{
      max-width:1280px;
      margin: 18px auto 26px;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
    }

    .card{
      border-radius: 20px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardInner{ padding: 16px; }
    .h{
      font-size: 12px;
      letter-spacing: .22em;
      color: rgba(255,255,255,.72);
      text-transform: uppercase;
      margin: 0 0 10px;
    }
    .bigKey{
      border-radius: 18px;
      background:
        radial-gradient(220px 140px at 25% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 55px rgba(0,0,0,.40);
      padding: 18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .bigKeyLeft{display:flex; flex-direction:column; gap:6px}
    .keyLabel{font-size:11px; color:var(--muted); letter-spacing:.12em; text-transform:uppercase}
    .keyName{
      font-size: 44px;
      font-weight: 1000;
      letter-spacing: .06em;
      line-height:1.05;
    }
    .miniMeta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      text-align:right;
    }
    .chip{
      font-family: var(--mono);
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .chip.on{
      border-color: rgba(162,155,255,.45);
      background: rgba(108,92,231,.18);
      box-shadow: 0 0 0 4px rgba(108,92,231,.08);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .kv{
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      min-height: 62px;
    }
    .kv b{display:block; font-size:11px; color:var(--muted)}
    .kv span{font-family: var(--mono); font-size:12px; color: rgba(255,255,255,.86); word-break:break-word}
    .rowLine{height:1px; background:rgba(255,255,255,.06); margin: 14px 0;}

    /* KB stage full-width feel */
    .kbStage{
      border-radius: 22px;
      background: rgba(8,8,16,.70);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height: 78vh;
      display:flex;
      flex-direction:column;
    }
    .kbBar{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .kbBar .left{
      display:flex; flex-direction:column; gap:3px;
      min-width: 260px;
    }
    .kbBar .left b{font-size:13px}
    .kbBar .left span{font-size:12px; color:var(--muted)}
    .kbBar .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .kbInner{
      flex:1;
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:auto;
    }

    /* Keyboard */
    .keyboard{
      --k: clamp(42px, 3.1vw, 66px);
      --gap: clamp(8px, 0.9vw, 12px);
      display:flex; flex-direction:column; gap: var(--gap);
      width: max-content;
      padding: 6px;
    }
    .kRow{display:flex; gap: var(--gap); align-items:stretch}
    .spacer{flex: 1}

    .key{
      position:relative;
      width: var(--k);
      height: calc(var(--k) * 1.10);
      padding: 10px 12px;
      border-radius: 14px;
      background:
        radial-gradient(140px 90px at 24% 18%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.14),
        0 18px 35px rgba(0,0,0,.45);
      user-select:none;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      transition: transform .06s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .key .kTop{font-size: 11px; opacity: .62; font-family: var(--mono);}
    .key .kMain{font-size: 16px; font-weight: 1000; letter-spacing: .18px;}
    .key .kCode{font-size: 10px; opacity: .40; font-family: var(--mono); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .key.w1_25{width: calc(var(--k) * 1.25)}
    .key.w1_5{width: calc(var(--k) * 1.50)}
    .key.w1_75{width: calc(var(--k) * 1.75)}
    .key.w2{width: calc(var(--k) * 2.00)}
    .key.w2_25{width: calc(var(--k) * 2.25)}
    .key.w2_75{width: calc(var(--k) * 2.75)}
    .key.w6{width: calc(var(--k) * 6.20)}
    .key.pressed{
      transform: translateY(1px) scale(.99);
      border-color: rgba(162,155,255,.55);
      background:
        radial-gradient(140px 90px at 24% 18%, rgba(162,155,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(108,92,231,.16), rgba(255,255,255,.02));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.16),
        0 0 0 4px rgba(108,92,231,.10),
        0 26px 60px rgba(0,0,0,.55);
    }
    .key.pressed::after{
      content:"";
      position:absolute; inset:-10px;
      border-radius: 18px;
      background: radial-gradient(circle at 35% 25%, rgba(162,155,255,.18), transparent 55%);
      pointer-events:none;
    }
    .key.sticky{
      border-color: rgba(255,210,0,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 0 0 4px rgba(255,210,0,.08), 0 18px 45px rgba(0,0,0,.50);
    }

    /* History / tools */
    .toolsRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btn:active{transform: translateY(1px)}
    .log{
      max-height: 260px;
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      padding: 10px;
      margin-top: 10px;
    }
    .logRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .logRow:last-child{border-bottom:none}
    .logLeft{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .logMeta{font-size:11px; color: var(--muted); white-space:nowrap}

    .note{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Focus overlay helper (no bottom-right icons) */
    .focusHint{
      display:flex; align-items:center; gap:8px;
      font-size: 12px; color: var(--muted);
      margin-top: 10px;
    }
    .focusBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      font-weight: 900;
      cursor:pointer;
    }
    .focusBadge.on{
      border-color: rgba(85,239,196,.28);
      background: rgba(85,239,196,.08);
    }

    /* Make sure no random floating buttons appear */
    #focusTop, #toTop, #scrollTop, .toTop, .scrollTop, .fab, .floating, .cornerBadge, .bottomRight {
      display:none !important;
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <div class="logo">K</div>
        <div class="brandTxt">
          <b>–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</b>
          <span>–í–∏–∑—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + numpad, –∏—Å—Ç–æ—Ä–∏—è, export CSV, ghosting/rollover. –í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ.</span>
        </div>
      </div>

      <div class="controls">
        <div class="pill" id="livePill" title="–°—Ç–∞—Ç—É—Å">
          <span class="dot live" id="liveDot"></span>
          <span id="liveText">Live</span>
        </div>

        <button class="pill pillOn" id="captureBtn" title="Capture Mode: –º–µ–Ω—å—à–µ –º–µ—à–∞—é—Ç —Ö–æ—Ç–∫–µ–∏/–ø—Ä–æ–∫—Ä—É—Ç–∫–∞">
          Capture: ON
        </button>

        <button class="pill" id="langBtn" title="–ú–µ–Ω—è–µ—Ç –Ω–∞–¥–ø–∏—Å–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ">RU</button>
        <button class="pill" id="osBtn" title="–ü–æ–¥–ø–∏—Å–∏ Win/Mac">Windows</button>

        <button class="pill ghostBtn" id="installBtn" hidden title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (PWA)">
          –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    </div>
  </header>

  <main class="wrap" id="app" tabindex="0" aria-label="Keyboard tester app">
    <!-- LEFT: Info -->
    <section class="card">
      <div class="cardInner">
        <div class="h">–¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏—à–∞</div>

        <div class="bigKey">
          <div class="bigKeyLeft">
            <div class="keyLabel">–Ω–∞–∂–∞—Ç–∞</div>
            <div class="keyName" id="bigKeyName">‚Äî</div>
          </div>

          <div class="miniMeta">
            <span class="chip" id="chipKey">event.key: ‚Äî</span>
            <span class="chip" id="chipCode">event.code: ‚Äî</span>
            <span class="chip" id="chipKeyCode">keyCode: ‚Äî</span>
          </div>
        </div>

        <div class="grid2">
          <div class="kv"><b>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b><span id="loc">‚Äî</span></div>
          <div class="kv"><b>–ü–æ–≤—Ç–æ—Ä (repeat)</b><span id="rep">‚Äî</span></div>
          <div class="kv"><b>–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã (count)</b><span id="downCount">0</span></div>
          <div class="kv"><b>–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–µ—Å—Å–∏—é</b><span id="maxCount">0</span></div>
        </div>

        <div class="rowLine"></div>

        <div class="h">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="chip" id="mCtrl">Ctrl</span>
          <span class="chip" id="mAlt">Alt</span>
          <span class="chip" id="mShift">Shift</span>
          <span class="chip" id="mMeta">Win/‚åò</span>
          <span class="chip" id="mCaps">Caps</span>
          <span class="chip" id="mNum">Num</span>
        </div>

        <div class="focusHint">
          <span class="focusBadge" id="focusBadge">–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å</span>
          <span>–ö–ª–∏–∫–Ω–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî –∏ –∂–º–∏ –∫–ª–∞–≤–∏—à–∏. –í Capture Mode –º–µ–Ω—å—à–µ –º–µ—à–∞—é—Ç —Ö–æ—Ç–∫–µ–∏/—Å–∫—Ä–æ–ª–ª.</span>
        </div>

        <div class="rowLine"></div>

        <div class="h">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π</div>
        <div class="toolsRow">
          <button class="btn" id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" id="csvBtn">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
          <button class="btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="log" id="log"></div>

        <div class="rowLine"></div>
        <div class="note">
          –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–¥—ë—Ç –ø–æ <b>event.code</b> ‚Äî —ç—Ç–æ ‚Äú—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è‚Äù –∫–ª–∞–≤–∏—à–∞, –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∏–≥—Ä/–Ω–∞—Å—Ç—Ä–æ–µ–∫.<br/>
          <b>event.key</b> –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å–∫–ª–∞–¥–∫–∏ (RU/EN) –≤ —Å–∏—Å—Ç–µ–º–µ.
        </div>
      </div>
    </section>

    <!-- RIGHT: Full keyboard stage -->
    <section class="kbStage card">
      <div class="kbBar">
        <div class="left">
          <b>–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–ø–æ–ª–Ω—ã–π layout)</b>
          <span>–°—Ç—Ä–µ–ª–∫–∏ + –Ω–∞–≤–∏–≥–∞—Ü–∏—è + numpad. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å RU/EN –º–µ–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∏.</span>
        </div>
        <div class="right">
          <span class="chip" id="privacy">–ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</span>
          <span class="chip" id="swStatus">Offline cache: ok</span>
        </div>
      </div>

      <div class="kbInner">
        <div id="keyboard" class="keyboard" aria-label="Keyboard visualization"></div>
      </div>
    </section>
  </main>

  <script>
    // =========================
    // STATE
    // =========================
    const app = document.getElementById("app");

    let CAPTURE = true;
    let UI_LANG = "ru";  // "ru" | "en"
    let UI_OS   = "win"; // "win" | "mac"

    const down = new Set();
    let maxDown = 0;

    const history = [];
    const HISTORY_LIMIT = 25;

    // =========================
    // UI refs
    // =========================
    const bigKeyName = document.getElementById("bigKeyName");
    const chipKey = document.getElementById("chipKey");
    const chipCode = document.getElementById("chipCode");
    const chipKeyCode = document.getElementById("chipKeyCode");
    const locEl = document.getElementById("loc");
    const repEl = document.getElementById("rep");
    const downCountEl = document.getElementById("downCount");
    const maxCountEl = document.getElementById("maxCount");

    const mCtrl = document.getElementById("mCtrl");
    const mAlt  = document.getElementById("mAlt");
    const mShift= document.getElementById("mShift");
    const mMeta = document.getElementById("mMeta");
    const mCaps = document.getElementById("mCaps");
    const mNum  = document.getElementById("mNum");

    const focusBadge = document.getElementById("focusBadge");
    const logEl = document.getElementById("log");

    const captureBtn = document.getElementById("captureBtn");
    const langBtn = document.getElementById("langBtn");
    const osBtn = document.getElementById("osBtn");

    const copyBtn = document.getElementById("copyBtn");
    const csvBtn = document.getElementById("csvBtn");
    const clearBtn = document.getElementById("clearBtn");

    const installBtn = document.getElementById("installBtn");
    const swStatus = document.getElementById("swStatus");

    // =========================
    // Keyboard layout (FULL)
    // =========================
    const RU = {
      Backquote:"–Å",
      KeyQ:"–ô",KeyW:"–¶",KeyE:"–£",KeyR:"–ö",KeyT:"–ï",KeyY:"–ù",KeyU:"–ì",KeyI:"–®",KeyO:"–©",KeyP:"–ó",
      BracketLeft:"–•",BracketRight:"–™",
      KeyA:"–§",KeyS:"–´",KeyD:"–í",KeyF:"–ê",KeyG:"–ü",KeyH:"–†",KeyJ:"–û",KeyK:"–õ",KeyL:"–î",
      Semicolon:"–ñ",Quote:"–≠",
      KeyZ:"–Ø",KeyX:"–ß",KeyC:"–°",KeyV:"–ú",KeyB:"–ò",KeyN:"–¢",KeyM:"–¨",
      Comma:"–ë",Period:"–Æ",
      Slash:"."
    };

    const EN_SHIFT = {
      Backquote:"~", Digit1:"!", Digit2:"@", Digit3:"#", Digit4:"$", Digit5:"%",
      Digit6:"^", Digit7:"&", Digit8:"*", Digit9:"(", Digit0:")",
      Minus:"_", Equal:"+", BracketLeft:"{", BracketRight:"}", Backslash:"|",
      Semicolon:":", Quote:'"', Comma:"<", Period:">", Slash:"?"
    };
    const RU_SHIFT = {
      Digit1:"!", Digit2:'"', Digit3:"‚Ññ", Digit4:";", Digit5:"%", Digit6:":",
      Digit7:"?", Digit8:"*", Digit9:"(", Digit0:")",
      Minus:"_", Equal:"+", Slash:",", Backquote:"–Å"
    };

    const LAYOUT = [
      // r1: esc + F + prt + nav + numpad top
      [
        K("Escape","Esc"),
        S(0.6),
        K("F1","F1"),K("F2","F2"),K("F3","F3"),K("F4","F4"),
        S(0.35),
        K("F5","F5"),K("F6","F6"),K("F7","F7"),K("F8","F8"),
        S(0.35),
        K("F9","F9"),K("F10","F10"),K("F11","F11"),K("F12","F12"),
        S(0.35),
        K("PrintScreen","Prt"),K("ScrollLock","Scr"),K("Pause","Pause"),
        S(0.35),
        K("NumLock","Num"),
        K("NumpadDivide","/"),K("NumpadMultiply","*"),K("NumpadSubtract","-")
      ],
      // r2: ` 123... backspace + insert/home/pgup + numpad 789 +
      [
        K("Backquote","`","~"),
        K("Digit1","1","!"),K("Digit2","2","@"),K("Digit3","3","#"),K("Digit4","4","$"),K("Digit5","5","%"),
        K("Digit6","6","^"),K("Digit7","7","&"),K("Digit8","8","*"),K("Digit9","9","("),K("Digit0","0",")"),
        K("Minus","-","_"),K("Equal","=","+"),
        K("Backspace","Backspace","", "w2"),
        S(0.35),
        K("Insert","Ins"),K("Home","Home"),K("PageUp","PgUp"),
        S(0.35),
        K("Numpad7","7"),K("Numpad8","8"),K("Numpad9","9"),
        K("NumpadAdd","+","", "h2")
      ],
      // r3: tab qwerty + []\ + del/end/pgdn + numpad 456
      [
        K("Tab","Tab","", "w1_5"),
        K("KeyQ","Q"),K("KeyW","W"),K("KeyE","E"),K("KeyR","R"),K("KeyT","T"),K("KeyY","Y"),K("KeyU","U"),K("KeyI","I"),K("KeyO","O"),K("KeyP","P"),
        K("BracketLeft","[","{"),K("BracketRight","]","}"),
        K("Backslash","\\","|","w1_5"),
        S(0.35),
        K("Delete","Del"),K("End","End"),K("PageDown","PgDn"),
        S(0.35),
        K("Numpad4","4"),K("Numpad5","5"),K("Numpad6","6")
      ],
      // r4: caps asdf... enter + (gap) + numpad 123 enter
      [
        K("CapsLock","Caps","", "w1_75"),
        K("KeyA","A"),K("KeyS","S"),K("KeyD","D"),K("KeyF","F"),K("KeyG","G"),K("KeyH","H"),K("KeyJ","J"),K("KeyK","K"),K("KeyL","L"),
        K("Semicolon","; ",":"),K("Quote","' ",'"'),
        K("Enter","Enter","", "w2_25"),
        S(0.35),
        S(2.0),
        S(0.35),
        K("Numpad1","1"),K("Numpad2","2"),K("Numpad3","3"),
        K("NumpadEnter","Enter","", "h2")
      ],
      // r5: shift zxc... shift + (gap) + numpad 0 .
      [
        K("ShiftLeft","Shift","", "w2_25"),
        K("KeyZ","Z"),K("KeyX","X"),K("KeyC","C"),K("KeyV","V"),K("KeyB","B"),K("KeyN","N"),K("KeyM","M"),
        K("Comma",",","<"),K("Period",".",">"),K("Slash","/","?"),
        K("ShiftRight","Shift","", "w2_75"),
        S(0.35),
        S(2.0),
        S(0.35),
        K("Numpad0","0","", "w2"),
        K("NumpadDecimal",".")
      ],
      // r6: ctrl win alt space alt win menu ctrl + arrows cluster
      [
        K("ControlLeft","Ctrl","", "w1_5"),
        K("MetaLeft","Win","", "w1_5"),
        K("AltLeft","Alt","", "w1_5"),
        K("Space","Space","", "w6"),
        K("AltRight","Alt","", "w1_5"),
        K("MetaRight","Win","", "w1_5"),
        K("ContextMenu","Menu","", "w1_5"),
        K("ControlRight","Ctrl","", "w1_75"),
        S(0.35),
        K("ArrowLeft","‚óÑ"),
        K("ArrowUp","‚ñ≤"),
        K("ArrowDown","‚ñº"),
        K("ArrowRight","‚ñ∫")
      ]
    ];

    function K(code, main, top="", sizeClass=""){
      return {type:"key", code, main, top, sizeClass};
    }
    function S(flex=1){
      return {type:"spacer", flex};
    }

    // =========================
    // Render keyboard
    // =========================
    const keyboard = document.getElementById("keyboard");

    function el(tag, cls){
      const x = document.createElement(tag);
      if (cls) x.className = cls;
      return x;
    }

    function renderKeyboard(){
      keyboard.innerHTML = "";
      LAYOUT.forEach((row) => {
        const r = el("div","kRow");
        row.forEach((item) => {
          if (item.type === "spacer"){
            const sp = el("div","spacer");
            sp.style.flex = String(item.flex);
            r.appendChild(sp);
            return;
          }
          const k = el("div","key " + (item.sizeClass || ""));
          k.dataset.code = item.code;

          const top = el("div","kTop");
          const main = el("div","kMain");
          const code = el("div","kCode");

          top.textContent = item.top || "";
          main.textContent = item.main || "";
          code.textContent = item.code;

          k.appendChild(top);
          k.appendChild(main);
          k.appendChild(code);

          r.appendChild(k);
        });
        keyboard.appendChild(r);
      });

      applyKeyLegends();
    }

    function byCode(code){
      return keyboard.querySelector(`[data-code="${code}"]`);
    }

    // =========================
    // Apply RU/EN legends
    // =========================
    function applyKeyLegends(){
      keyboard.querySelectorAll(".key[data-code]").forEach((k) => {
        const code = k.dataset.code;
        const topEl = k.querySelector(".kTop");
        const mainEl = k.querySelector(".kMain");

        // OS labels
        if (code === "MetaLeft" || code === "MetaRight"){
          mainEl.textContent = (UI_OS === "mac") ? "‚åò" : "Win";
          topEl.textContent = "";
          return;
        }
        if (code === "AltLeft" || code === "AltRight"){
          mainEl.textContent = (UI_OS === "mac") ? "‚å•" : "Alt";
          topEl.textContent = "";
          return;
        }

        // Letters
        if (code.startsWith("Key")){
          const letter = code.replace("Key","");
          if (UI_LANG === "ru"){
            mainEl.textContent = RU[code] || letter;
            topEl.textContent = "";
          } else {
            mainEl.textContent = letter;
            topEl.textContent = "";
          }
          return;
        }

        // Digits
        if (code.startsWith("Digit")){
          const d = code.replace("Digit","");
          mainEl.textContent = d;
          topEl.textContent = (UI_LANG === "ru") ? (RU_SHIFT[code] || EN_SHIFT[code] || "") : (EN_SHIFT[code] || "");
          return;
        }

        // Punctuation top labels
        const topMap = (UI_LANG === "ru") ? RU_SHIFT : EN_SHIFT;
        if (topMap[code]) topEl.textContent = topMap[code];

        // For RU: special mapping for backquote
        if (UI_LANG === "ru" && code === "Backquote"){
          mainEl.textContent = RU.Backquote;
        }
      });
    }

    // =========================
    // Capture mode
    // =========================
    function shouldPrevent(e){
      if (!CAPTURE) return false;

      // –ù–µ –ª–æ–º–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–æ —É–º–µ–Ω—å—à–∞–µ–º —Å–∫—Ä–æ–ª–ª/—Ö–æ—Ç–∫–µ–∏.
      // –ú–æ–∂–µ—à—å —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –Ω–∞–¥–æ.
      const preventCodes = new Set([
        "Space",
        "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
        "PageUp","PageDown","Home","End"
      ]);

      // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç—ã Ctrl/Meta ‚Äî —á–∞—Å—Ç–æ —ç—Ç–æ —Ö–æ—Ç–∫–µ–∏ –±—Ä–∞—É–∑–µ—Ä–∞. –í capture –º–æ–∂–Ω–æ –∏—Ö —Ç–æ–∂–µ –≥–∞—Å–∏—Ç—å.
      if ((e.ctrlKey || e.metaKey) && CAPTURE) return true;

      return preventCodes.has(e.code);
    }

    // =========================
    // Focus handling
    // =========================
    function setFocusState(on){
      focusBadge.classList.toggle("on", on);
      focusBadge.textContent = on ? "–§–æ–∫—É—Å –µ—Å—Ç—å" : "–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å";
    }

    document.addEventListener("click", () => {
      app.focus({preventScroll:true});
    });
    app.addEventListener("focus", () => setFocusState(true));
    app.addEventListener("blur", () => setFocusState(false));

    focusBadge.addEventListener("click", () => app.focus({preventScroll:true}));

    // =========================
    // Key helpers
    // =========================
    function keyLocationName(code){
      if (code.endsWith("Left")) return "–ª–µ–≤–∞—è";
      if (code.endsWith("Right")) return "–ø—Ä–∞–≤–∞—è";
      if (code.startsWith("Numpad")) return "numpad";
      return "‚Äî";
    }

    function setModChip(chip, on){
      chip.classList.toggle("on", on);
    }

    function updateModsFromEvent(e){
      setModChip(mCtrl,  e.ctrlKey);
      setModChip(mAlt,   e.altKey);
      setModChip(mShift, e.shiftKey);
      setModChip(mMeta,  e.metaKey);
      // Caps/Num lock (—á–µ—Ä–µ–∑ getModifierState)
      try{
        setModChip(mCaps, e.getModifierState && e.getModifierState("CapsLock"));
        setModChip(mNum,  e.getModifierState && e.getModifierState("NumLock"));
      }catch{}
    }

    // =========================
    // History UI
    // =========================
    function pushHistory(entry){
      history.unshift(entry);
      if (history.length > HISTORY_LIMIT) history.pop();
      renderHistory();
    }

    function renderHistory(){
      logEl.innerHTML = "";
      if (!history.length){
        const empty = document.createElement("div");
        empty.className = "note";
        empty.style.padding = "6px 4px";
        empty.textContent = "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –ù–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏ üôÇ";
        logEl.appendChild(empty);
        return;
      }

      history.forEach((h) => {
        const row = document.createElement("div");
        row.className = "logRow";

        const left = document.createElement("div");
        left.className = "logLeft";

        const c1 = document.createElement("span");
        c1.className = "chip";
        c1.textContent = h.key;

        const c2 = document.createElement("span");
        c2.className = "chip";
        c2.textContent = h.code;

        left.appendChild(c1);
        left.appendChild(c2);

        const meta = document.createElement("div");
        meta.className = "logMeta";
        meta.textContent = `${h.time} ¬∑ keyCode:${h.keyCode}${h.repeat ? " ¬∑ repeat" : ""}`;

        row.appendChild(left);
        row.appendChild(meta);
        logEl.appendChild(row);
      });
    }

    function toTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }

    function exportCSV(){
      const header = ["time","key","code","keyCode","repeat"].join(",");
      const rows = history
        .slice().reverse()
        .map(h => [h.time, safeCSV(h.key), safeCSV(h.code), h.keyCode, h.repeat ? 1 : 0].join(","));
      return [header, ...rows].join("\n");
    }

    function safeCSV(v){
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    async function copyHistory(){
      const lines = history
        .slice().reverse()
        .map(h => `${h.time}\t${h.key}\t${h.code}\tkeyCode:${h.keyCode}${h.repeat ? "\trepeat" : ""}`)
        .join("\n");
      await navigator.clipboard.writeText(lines || "");
    }

    // =========================
    // Events
    // =========================
    window.addEventListener("keydown", (e) => {
      if (shouldPrevent(e)) e.preventDefault();

      down.add(e.code);
      if (down.size > maxDown) maxDown = down.size;

      // Visual pressed
      const keyEl = byCode(e.code);
      if (keyEl) keyEl.classList.add("pressed");

      // Update main info
      bigKeyName.textContent = (e.key && e.key.length === 1) ? e.key.toUpperCase() : (e.key || "‚Äî");
      chipKey.textContent = `event.key: ${e.key ?? "‚Äî"}`;
      chipCode.textContent = `event.code: ${e.code ?? "‚Äî"}`;
      chipKeyCode.textContent = `keyCode: ${e.keyCode ?? "‚Äî"}`;

      locEl.textContent = keyLocationName(e.code);
      repEl.textContent = e.repeat ? "–¥–∞" : "–Ω–µ—Ç";

      downCountEl.textContent = String(down.size);
      maxCountEl.textContent = String(maxDown);

      updateModsFromEvent(e);

      // Sticky highlight for lock keys
      if (e.code === "CapsLock" || e.code === "NumLock"){
        if (keyEl) keyEl.classList.toggle("sticky", e.getModifierState && e.getModifierState(e.code === "CapsLock" ? "CapsLock" : "NumLock"));
      }

      // History (–Ω–µ —Å–ø–∞–º–∏–º –ø–æ–≤—Ç–æ—Ä–∞–º–∏ —Å–ª–∏—à–∫–æ–º)
      pushHistory({
        time: toTime(),
        key: e.key ?? "",
        code: e.code ?? "",
        keyCode: e.keyCode ?? "",
        repeat: !!e.repeat
      });
    }, {passive:false});

    window.addEventListener("keyup", (e) => {
      if (shouldPrevent(e)) e.preventDefault();

      down.delete(e.code);
      downCountEl.textContent = String(down.size);

      const keyEl = byCode(e.code);
      if (keyEl) keyEl.classList.remove("pressed");
    }, {passive:false});

    window.addEventListener("blur", () => {
      // remove stuck pressed when alt-tab
      down.forEach(code => {
        const keyEl = byCode(code);
        if (keyEl) keyEl.classList.remove("pressed");
      });
      down.clear();
      downCountEl.textContent = "0";
      setFocusState(false);
    });

    // =========================
    // Buttons
    // =========================
    captureBtn.addEventListener("click", () => {
      CAPTURE = !CAPTURE;
      captureBtn.classList.toggle("pillOn", CAPTURE);
      captureBtn.textContent = `Capture: ${CAPTURE ? "ON" : "OFF"}`;
    });

    langBtn.addEventListener("click", () => {
      UI_LANG = (UI_LANG === "ru") ? "en" : "ru";
      langBtn.textContent = UI_LANG.toUpperCase();
      applyKeyLegends();
    });

    osBtn.addEventListener("click", () => {
      UI_OS = (UI_OS === "win") ? "mac" : "win";
      osBtn.textContent = (UI_OS === "mac") ? "Mac" : "Windows";
      applyKeyLegends();
    });

    copyBtn.addEventListener("click", async () => {
      try{
        await copyHistory();
        copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì";
        setTimeout(()=>copyBtn.textContent="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 900);
      }catch{
        copyBtn.textContent = "–û—à–∏–±–∫–∞";
        setTimeout(()=>copyBtn.textContent="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 900);
      }
    });

    csvBtn.addEventListener("click", () => {
      const csv = exportCSV();
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "keyboard-history.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener("click", () => {
      history.length = 0;
      renderHistory();
    });

    // =========================
    // PWA install
    // =========================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.hidden = true;
    });

    // =========================
    // Service Worker
    // =========================
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js")
        .then(() => swStatus.textContent = "Offline cache: ok")
        .catch(() => swStatus.textContent = "Offline cache: error");
    } else {
      swStatus.textContent = "Offline cache: n/a";
    }
/* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∞—è */
.keyboardWrap{
  width: 100% !important;
  max-width: none !important;
}

/* –ß—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–Ω–∏–º–∞–ª–∞ –ø–æ—á—Ç–∏ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –ø–æ –≤—ã—Å–æ—Ç–µ */
.keyboardCard{
  height: calc(100vh - 140px) !important; /* 140px ‚Äî –∑–∞–ø–∞—Å –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏/—à–∞–ø–∫—É */
  display: flex !important;
  flex-direction: column !important;
}

/* –û–±–ª–∞—Å—Ç—å —Å–∞–º–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—É—Å—Ç—å —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
.keyboard{
  flex: 1 !important;
  height: 100% !important;
}

/* –ï—Å–ª–∏ —É —Ç–µ–±—è –±—ã–ª–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ‚Äî —É–±–∏—Ä–∞–µ–º, –ø—É—Å—Ç—å —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
.keyboardScroll{
  overflow: visible !important;
}

/* –ö–Ω–æ–ø–∫–∏ –±–æ–ª—å—à–µ –∏ ‚Äú–¥–æ—Ä–æ–∂–µ‚Äù –≤—ã–≥–ª—è–¥—è—Ç */
.key{
  min-height: 52px !important;
  font-size: 14px !important;
  border-radius: 14px !important;
}

/* –ß—Ç–æ–±—ã –≤—Å—ë –Ω–µ —É–ø–∏—Ä–∞–ª–æ—Å—å –≤ –∫—Ä–∞—è */
.mainCol{
  padding-right: 0 !important;
}

    // init
    renderKeyboard();
    renderHistory();
    setFocusState(false);
  </script>
</body>
</html> 


