<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b14" />

  <title>Тестер клавиатуры — Keyboard Tester</title>
  <meta name="description" content="Проверка клавиатуры: подсветка нажатий, numpad, стрелки, история, экспорт, rollover/ghosting. Работает локально и офлайн (PWA)." />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" sizes="any" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root{
      --bg0:#070710;
      --bg1:#0b0b14;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.64);

      --accent: rgba(162,155,255,.85);
      --good: rgba(85,239,196,.85);

      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 16px 40px rgba(0,0,0,.40);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:var(--sans);
      background:
        radial-gradient(1000px 600px at 20% 12%, rgba(162,155,255,.22), transparent 60%),
        radial-gradient(900px 520px at 86% 30%, rgba(85,239,196,.12), transparent 60%),
        radial-gradient(800px 520px at 40% 95%, rgba(108,92,231,.10), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden; /* ВАЖНО: никаких скроллов страницы */
    }

    /* Top bar */
    header.top{
      height:64px;
      display:flex;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(7,7,16,.92), rgba(7,7,16,.70));
      backdrop-filter: blur(10px);
      padding:0 14px;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      font-weight:900;
      letter-spacing:.5px;
      user-select:none;
    }
    .brandTxt{display:flex; flex-direction:column; gap:2px}
    .brandTxt b{font-size:14px; letter-spacing:.2px}
    .brandTxt span{font-size:12px; color:var(--muted)}

    .controls{
      margin-left:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .pill:active{transform: translateY(1px)}
    .pillOn{
      border-color: rgba(162,155,255,.35);
      background: rgba(108,92,231,.16);
      box-shadow: 0 0 0 4px rgba(108,92,231,.08);
    }
    .dot{
      width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.4);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.live{ background: var(--good); box-shadow: 0 0 0 4px rgba(85,239,196,.10), 0 0 18px rgba(85,239,196,.35);}

    /* App layout: keyboard takes all remaining space */
    .app{
      height: calc(100vh - 64px);
      display:flex;
      position:relative;
      overflow:hidden;
    }

    /* Keyboard stage (full screen) */
    .stage{
      flex:1;
      position:relative;
      padding:14px;
      overflow:hidden;
    }
    .stageCard{
      position:absolute;
      inset:14px;
      border-radius: 22px;
      background: rgba(8,8,16,.70);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .stageBar{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .stageBar b{font-size:13px}
    .stageBar span{font-size:12px; color:var(--muted)}
    .stageRight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      font-family: var(--mono);
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.88);
      white-space:nowrap;
      user-select:none;
    }

    /* THIS is the important part: NO SCROLL, auto-fit by scale */
    .kbViewport{
      flex:1;
      min-height:0;
      display:grid;
      place-items:center;
      overflow:hidden;          /* <- никаких внутренних скроллов */
      padding: 10px;
    }
    .kbScale{
      transform-origin: center center;
      will-change: transform;
    }

    /* Keyboard */
    .keyboard{
      --k: 58px;   /* базовый размер, дальше масштабируется JS-ом */
      --gap: 10px;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      width: max-content;
      padding: 6px;
      user-select:none;
    }
    .kRow{display:flex; gap: var(--gap); align-items:stretch}
    .spacer{flex:1}

    .key{
      width: var(--k);
      height: calc(var(--k) * 1.10);
      padding: 10px 12px;
      border-radius: 14px;
      background:
        radial-gradient(140px 90px at 24% 18%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.14),
        0 18px 35px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      transition: transform .06s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease;
      position:relative;
      overflow:hidden;
    }
    .key .kTop{font-size: 11px; opacity: .62; font-family: var(--mono);}
    .key .kMain{font-size: 16px; font-weight: 1000; letter-spacing: .18px;}
    .key .kCode{font-size: 10px; opacity: .40; font-family: var(--mono); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .key.w1_25{width: calc(var(--k) * 1.25)}
    .key.w1_5{width: calc(var(--k) * 1.50)}
    .key.w1_75{width: calc(var(--k) * 1.75)}
    .key.w2{width: calc(var(--k) * 2.00)}
    .key.w2_25{width: calc(var(--k) * 2.25)}
    .key.w2_75{width: calc(var(--k) * 2.75)}
    .key.w6{width: calc(var(--k) * 6.20)}

    .key.pressed{
      transform: translateY(1px) scale(.99);
      border-color: rgba(162,155,255,.55);
      background:
        radial-gradient(140px 90px at 24% 18%, rgba(162,155,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(108,92,231,.16), rgba(255,255,255,.02));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.16),
        0 0 0 4px rgba(108,92,231,.10),
        0 26px 60px rgba(0,0,0,.55);
    }
    .key.pressed::after{
      content:"";
      position:absolute; inset:-10px;
      border-radius: 18px;
      background: radial-gradient(circle at 35% 25%, rgba(162,155,255,.18), transparent 55%);
      pointer-events:none;
    }
    .key.sticky{
      border-color: rgba(255,210,0,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 0 0 4px rgba(255,210,0,.08), 0 18px 45px rgba(0,0,0,.50);
    }

    /* Drawer (left info/history) */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .overlay.on{opacity:1; pointer-events:auto;}

    aside.drawer{
      position:absolute;
      top:14px; bottom:14px; left:14px;
      width: 380px;
      max-width: calc(100vw - 28px);
      border-radius: 20px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transform: translateX(calc(-100% - 18px));
      transition: transform .18s ease;
      display:flex;
      flex-direction:column;
      z-index:5;
    }
    aside.drawer.on{transform: translateX(0);}

    .drawerInner{
      padding: 14px;
      overflow:auto;
      min-height:0;
    }
    .h{
      font-size: 12px;
      letter-spacing: .22em;
      color: rgba(255,255,255,.72);
      text-transform: uppercase;
      margin: 0 0 10px;
    }
    .bigKey{
      border-radius: 18px;
      background:
        radial-gradient(220px 140px at 25% 25%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 22px 55px rgba(0,0,0,.40);
      padding: 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .keyName{font-size: 42px; font-weight: 1000; letter-spacing: .06em; line-height:1.05;}
    .miniMeta{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; text-align:right;}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .kv{
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      min-height: 62px;
    }
    .kv b{display:block; font-size:11px; color:var(--muted)}
    .kv span{font-family: var(--mono); font-size:12px; color: rgba(255,255,255,.86); word-break:break-word}
    .rowLine{height:1px; background:rgba(255,255,255,.06); margin: 14px 0;}

    .toolsRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btn:active{transform: translateY(1px)}

    .log{
      max-height: 240px;
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      padding: 10px;
      margin-top: 10px;
    }
    .logRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .logRow:last-child{border-bottom:none}
    .logLeft{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .logMeta{font-size:11px; color: var(--muted); white-space:nowrap}

    .chip.on{
      border-color: rgba(162,155,255,.45);
      background: rgba(108,92,231,.18);
      box-shadow: 0 0 0 4px rgba(108,92,231,.08);
    }

    /* small screens */
    @media (max-width: 520px){
      header.top{height:auto; padding:10px 12px; flex-wrap:wrap}
      .app{height: calc(100vh - 92px);}
    }

    /* Best-effort: hide common floating widgets if THEY are in DOM (часто это расширения/виджеты) */
    .fab,.floating,.cornerBadge,.bottomRight,
    [id*="translate"],[class*="translate"],
    [id*="translator"],[class*="translator"]{
      display:none !important;
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="brand">
      <div class="logo">K</div>
      <div class="brandTxt">
        <b>Тестер клавиатуры</b>
        <span>Без скролла. Клавиатура всегда вписывается в экран.</span>
      </div>
    </div>

    <div class="controls">
      <div class="pill" title="Статус">
        <span class="dot live"></span>
        Live
      </div>

      <button class="pill pillOn" id="captureBtn" title="Capture Mode: меньше мешают хоткеи/скролл">
        Capture: ON
      </button>

      <button class="pill" id="langBtn" title="Надписи на виртуальной клавиатуре">RU</button>
      <button class="pill" id="osBtn" title="Win/Mac подписи">Windows</button>

      <button class="pill" id="panelBtn" title="Открыть панель (инфо/история)">Панель</button>

      <button class="pill" id="installBtn" hidden title="Установить как приложение (PWA)">Установить</button>
    </div>
  </header>

  <div class="app" id="app" tabindex="0" aria-label="Keyboard tester app">
    <div class="stage">
      <div class="stageCard">
        <div class="stageBar">
          <div>
            <b>Виртуальная клавиатура</b><br>
            <span>Подсветка по <span style="font-family:var(--mono)">event.code</span> (физическая клавиша).</span>
          </div>
          <div class="stageRight">
            <span class="chip" id="swStatus">Offline cache: …</span>
            <span class="chip" id="scaleInfo">Scale: 100%</span>
          </div>
        </div>

        <div class="kbViewport" id="kbViewport" aria-label="Keyboard viewport">
          <div class="kbScale" id="kbScale">
            <div id="keyboard" class="keyboard" aria-label="Keyboard visualization"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <aside class="drawer" id="drawer">
      <div class="drawerInner">
        <div class="h">Текущая клавиша</div>

        <div class="bigKey">
          <div>
            <div style="font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;">нажата</div>
            <div class="keyName" id="bigKeyName">—</div>
          </div>
          <div class="miniMeta">
            <span class="chip" id="chipKey">event.key: —</span>
            <span class="chip" id="chipCode">event.code: —</span>
            <span class="chip" id="chipKeyCode">keyCode: —</span>
          </div>
        </div>

        <div class="grid2">
          <div class="kv"><b>Расположение</b><span id="loc">—</span></div>
          <div class="kv"><b>Повтор (repeat)</b><span id="rep">—</span></div>
          <div class="kv"><b>Сейчас зажаты</b><span id="downCount">0</span></div>
          <div class="kv"><b>Максимум</b><span id="maxCount">0</span></div>
        </div>

        <div class="rowLine"></div>

        <div class="h">Модификаторы</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="chip" id="mCtrl">Ctrl</span>
          <span class="chip" id="mAlt">Alt</span>
          <span class="chip" id="mShift">Shift</span>
          <span class="chip" id="mMeta">Win/⌘</span>
          <span class="chip" id="mCaps">Caps</span>
          <span class="chip" id="mNum">Num</span>
        </div>

        <div class="rowLine"></div>

        <div class="h">История нажатий</div>
        <div class="toolsRow">
          <button class="btn" id="copyBtn">Копировать</button>
          <button class="btn" id="csvBtn">Экспорт CSV</button>
          <button class="btn" id="clearBtn">Очистить</button>
        </div>

        <div class="log" id="log"></div>

        <div class="rowLine"></div>
        <div style="font-size:12px;color:var(--muted);line-height:1.35;">
          Если хоткеи браузера мешают — оставь <b>Capture ON</b>.<br>
          Для игр смотри <b>event.code</b> — это физическая клавиша.
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ===== State =====
    const app = document.getElementById("app");

    let CAPTURE = true;
    let UI_LANG = "ru";  // "ru" | "en"
    let UI_OS   = "win"; // "win" | "mac"

    const down = new Set();
    let maxDown = 0;

    const history = [];
    const HISTORY_LIMIT = 25;

    // ===== UI refs =====
    const keyboard = document.getElementById("keyboard");
    const kbViewport = document.getElementById("kbViewport");
    const kbScale = document.getElementById("kbScale");
    const scaleInfo = document.getElementById("scaleInfo");

    const drawer = document.getElementById("drawer");
    const overlay = document.getElementById("overlay");

    const panelBtn = document.getElementById("panelBtn");
    const captureBtn = document.getElementById("captureBtn");
    const langBtn = document.getElementById("langBtn");
    const osBtn = document.getElementById("osBtn");

    const bigKeyName = document.getElementById("bigKeyName");
    const chipKey = document.getElementById("chipKey");
    const chipCode = document.getElementById("chipCode");
    const chipKeyCode = document.getElementById("chipKeyCode");
    const locEl = document.getElementById("loc");
    const repEl = document.getElementById("rep");
    const downCountEl = document.getElementById("downCount");
    const maxCountEl = document.getElementById("maxCount");

    const mCtrl = document.getElementById("mCtrl");
    const mAlt  = document.getElementById("mAlt");
    const mShift= document.getElementById("mShift");
    const mMeta = document.getElementById("mMeta");
    const mCaps = document.getElementById("mCaps");
    const mNum  = document.getElementById("mNum");

    const logEl = document.getElementById("log");
    const copyBtn = document.getElementById("copyBtn");
    const csvBtn = document.getElementById("csvBtn");
    const clearBtn = document.getElementById("clearBtn");

    const installBtn = document.getElementById("installBtn");
    const swStatus = document.getElementById("swStatus");

    // ===== Legends =====
    const RU = {
      Backquote:"Ё",
      KeyQ:"Й",KeyW:"Ц",KeyE:"У",KeyR:"К",KeyT:"Е",KeyY:"Н",KeyU:"Г",KeyI:"Ш",KeyO:"Щ",KeyP:"З",
      BracketLeft:"Х",BracketRight:"Ъ",
      KeyA:"Ф",KeyS:"Ы",KeyD:"В",KeyF:"А",KeyG:"П",KeyH:"Р",KeyJ:"О",KeyK:"Л",KeyL:"Д",
      Semicolon:"Ж",Quote:"Э",
      KeyZ:"Я",KeyX:"Ч",KeyC:"С",KeyV:"М",KeyB:"И",KeyN:"Т",KeyM:"Ь",
      Comma:"Б",Period:"Ю",
      Slash:"."
    };

    const EN_SHIFT = {
      Backquote:"~", Digit1:"!", Digit2:"@", Digit3:"#", Digit4:"$", Digit5:"%",
      Digit6:"^", Digit7:"&", Digit8:"*", Digit9:"(", Digit0:")",
      Minus:"_", Equal:"+", BracketLeft:"{", BracketRight:"}", Backslash:"|",
      Semicolon:":", Quote:'"', Comma:"<", Period:">", Slash:"?"
    };
    const RU_SHIFT = {
      Digit1:"!", Digit2:'"', Digit3:"№", Digit4:";", Digit5:"%", Digit6:":",
      Digit7:"?", Digit8:"*", Digit9:"(", Digit0:")",
      Minus:"_", Equal:"+", Slash:",", Backquote:"Ё"
    };

    function K(code, main, top="", sizeClass=""){
      return {type:"key", code, main, top, sizeClass};
    }
    function S(flex=1){ return {type:"spacer", flex}; }

    // ===== Layout (FULL 104-ish) — без вертикальных спанов, зато без багов и скролла =====
    const LAYOUT = [
      [
        K("Escape","Esc"),
        S(0.6),
        K("F1","F1"),K("F2","F2"),K("F3","F3"),K("F4","F4"),
        S(0.35),
        K("F5","F5"),K("F6","F6"),K("F7","F7"),K("F8","F8"),
        S(0.35),
        K("F9","F9"),K("F10","F10"),K("F11","F11"),K("F12","F12"),
        S(0.35),
        K("PrintScreen","Prt"),K("ScrollLock","Scr"),K("Pause","Pause")
      ],
      [
        K("Backquote","`","~"),
        K("Digit1","1","!"),K("Digit2","2","@"),K("Digit3","3","#"),K("Digit4","4","$"),K("Digit5","5","%"),
        K("Digit6","6","^"),K("Digit7","7","&"),K("Digit8","8","*"),K("Digit9","9","("),K("Digit0","0",")"),
        K("Minus","-","_"),K("Equal","=","+"),
        K("Backspace","Backspace","", "w2"),
        S(0.35),
        K("Insert","Ins"),K("Home","Home"),K("PageUp","PgUp"),
        S(0.35),
        K("NumLock","Num"),
        K("NumpadDivide","/"),K("NumpadMultiply","*"),K("NumpadSubtract","-")
      ],
      [
        K("Tab","Tab","", "w1_5"),
        K("KeyQ","Q"),K("KeyW","W"),K("KeyE","E"),K("KeyR","R"),K("KeyT","T"),K("KeyY","Y"),K("KeyU","U"),K("KeyI","I"),K("KeyO","O"),K("KeyP","P"),
        K("BracketLeft","[","{"),K("BracketRight","]","}"),
        K("Backslash","\\","|","w1_5"),
        S(0.35),
        K("Delete","Del"),K("End","End"),K("PageDown","PgDn"),
        S(0.35),
        K("Numpad7","7"),K("Numpad8","8"),K("Numpad9","9"),K("NumpadAdd","+")
      ],
      [
        K("CapsLock","Caps","", "w1_75"),
        K("KeyA","A"),K("KeyS","S"),K("KeyD","D"),K("KeyF","F"),K("KeyG","G"),K("KeyH","H"),K("KeyJ","J"),K("KeyK","K"),K("KeyL","L"),
        K("Semicolon","; ",":"),K("Quote","' ",'"'),
        K("Enter","Enter","", "w2_25"),
        S(0.35),
        S(2.2),
        S(0.35),
        K("Numpad4","4"),K("Numpad5","5"),K("Numpad6","6"),K("NumpadAdd","+")
      ],
      [
        K("ShiftLeft","Shift","", "w2_25"),
        K("KeyZ","Z"),K("KeyX","X"),K("KeyC","C"),K("KeyV","V"),K("KeyB","B"),K("KeyN","N"),K("KeyM","M"),
        K("Comma",",","<"),K("Period",".",">"),K("Slash","/","?"),
        K("ShiftRight","Shift","", "w2_75"),
        S(0.35),
        S(1.0),K("ArrowUp","▲"),S(1.0),
        S(0.35),
        K("Numpad1","1"),K("Numpad2","2"),K("Numpad3","3"),K("NumpadEnter","Enter")
      ],
      [
        K("ControlLeft","Ctrl","", "w1_5"),
        K("MetaLeft","Win","", "w1_5"),
        K("AltLeft","Alt","", "w1_5"),
        K("Space","Space","", "w6"),
        K("AltRight","Alt","", "w1_5"),
        K("MetaRight","Win","", "w1_5"),
        K("ContextMenu","Menu","", "w1_5"),
        K("ControlRight","Ctrl","", "w1_75"),
        S(0.35),
        K("ArrowLeft","◄"),K("ArrowDown","▼"),K("ArrowRight","►"),
        S(0.35),
        K("Numpad0","0","", "w2"),
        K("NumpadDecimal","."),
        K("NumpadEnter","Enter")
      ]
    ];

    // ===== Render =====
    function el(tag, cls){
      const x = document.createElement(tag);
      if (cls) x.className = cls;
      return x;
    }

    function renderKeyboard(){
      keyboard.innerHTML = "";
      LAYOUT.forEach((row) => {
        const r = el("div","kRow");
        row.forEach((item) => {
          if (item.type === "spacer"){
            const sp = el("div","spacer");
            sp.style.flex = String(item.flex);
            r.appendChild(sp);
            return;
          }
          const k = el("div","key " + (item.sizeClass || ""));
          k.dataset.code = item.code;

          const top = el("div","kTop");
          const main = el("div","kMain");
          const code = el("div","kCode");

          top.textContent = item.top || "";
          main.textContent = item.main || "";
          code.textContent = item.code;

          k.appendChild(top);
          k.appendChild(main);
          k.appendChild(code);

          r.appendChild(k);
        });
        keyboard.appendChild(r);
      });

      applyKeyLegends();
      fitKeyboardToViewport();
    }

    function byCode(code){
      return keyboard.querySelector(`[data-code="${code}"]`);
    }

    function applyKeyLegends(){
      keyboard.querySelectorAll(".key[data-code]").forEach((k) => {
        const code = k.dataset.code;
        const topEl = k.querySelector(".kTop");
        const mainEl = k.querySelector(".kMain");

        // OS labels
        if (code === "MetaLeft" || code === "MetaRight"){
          mainEl.textContent = (UI_OS === "mac") ? "⌘" : "Win";
          topEl.textContent = "";
          return;
        }
        if (code === "AltLeft" || code === "AltRight"){
          mainEl.textContent = (UI_OS === "mac") ? "⌥" : "Alt";
          topEl.textContent = "";
          return;
        }

        // Letters
        if (code.startsWith("Key")){
          const letter = code.replace("Key","");
          if (UI_LANG === "ru"){
            mainEl.textContent = RU[code] || letter;
            topEl.textContent = "";
          } else {
            mainEl.textContent = letter;
            topEl.textContent = "";
          }
          return;
        }

        // Digits
        if (code.startsWith("Digit")){
          const d = code.replace("Digit","");
          mainEl.textContent = d;
          topEl.textContent = (UI_LANG === "ru")
            ? (RU_SHIFT[code] || EN_SHIFT[code] || "")
            : (EN_SHIFT[code] || "");
          return;
        }

        // Punct top labels
        const topMap = (UI_LANG === "ru") ? RU_SHIFT : EN_SHIFT;
        topEl.textContent = topMap[code] || topEl.textContent;

        // RU special for backquote main label
        if (UI_LANG === "ru" && code === "Backquote"){
          mainEl.textContent = RU.Backquote;
        }
      });
    }

    // ===== Fit keyboard to viewport (NO SCROLL) =====
    function fitKeyboardToViewport(){
      // natural size (no transforms on keyboard itself)
      const naturalW = keyboard.offsetWidth;
      const naturalH = keyboard.offsetHeight;
      const availW = kbViewport.clientWidth - 20;
      const availH = kbViewport.clientHeight - 20;

      if (!naturalW || !naturalH || !availW || !availH) return;

      // scale up/down to fit
      let scale = Math.min(availW / naturalW, availH / naturalH);

      // чуть ограничим, чтобы не было гигантских клавиш на огромных мониторах
      scale = Math.max(0.35, Math.min(scale, 1.25));

      kbScale.style.transform = `scale(${scale})`;
      scaleInfo.textContent = `Scale: ${Math.round(scale * 100)}%`;
    }

    const ro = new ResizeObserver(() => fitKeyboardToViewport());
    ro.observe(kbViewport);

    window.addEventListener("resize", () => fitKeyboardToViewport());

    // ===== Capture mode =====
    function shouldPrevent(e){
      if (!CAPTURE) return false;

      const preventCodes = new Set([
        "Space",
        "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
        "PageUp","PageDown","Home","End"
      ]);

      // В capture гасим хоткеи браузера
      if (e.ctrlKey || e.metaKey) return true;

      return preventCodes.has(e.code);
    }

    // ===== Drawer =====
    function openDrawer(on){
      drawer.classList.toggle("on", on);
      overlay.classList.toggle("on", on);
      // после открытия/закрытия меняется доступная ширина — пересчитать scale
      setTimeout(fitKeyboardToViewport, 220);
    }
    panelBtn.addEventListener("click", () => openDrawer(!drawer.classList.contains("on")));
    overlay.addEventListener("click", () => openDrawer(false));

    // ===== Helpers =====
    function keyLocationName(code){
      if (code.endsWith("Left")) return "левая";
      if (code.endsWith("Right")) return "правая";
      if (code.startsWith("Numpad")) return "numpad";
      return "—";
    }
    function setModChip(chip, on){ chip.classList.toggle("on", !!on); }

    function updateModsFromEvent(e){
      setModChip(mCtrl,  e.ctrlKey);
      setModChip(mAlt,   e.altKey);
      setModChip(mShift, e.shiftKey);
      setModChip(mMeta,  e.metaKey);
      try{
        setModChip(mCaps, e.getModifierState && e.getModifierState("CapsLock"));
        setModChip(mNum,  e.getModifierState && e.getModifierState("NumLock"));
      }catch{}
    }

    function toTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }

    // ===== History =====
    function pushHistory(entry){
      history.unshift(entry);
      if (history.length > HISTORY_LIMIT) history.pop();
      renderHistory();
    }

    function renderHistory(){
      logEl.innerHTML = "";
      if (!history.length){
        const empty = document.createElement("div");
        empty.style.padding = "6px 4px";
        empty.style.fontSize = "12px";
        empty.style.color = "rgba(255,255,255,.64)";
        empty.textContent = "История пуста.";
        logEl.appendChild(empty);
        return;
      }

      history.forEach((h) => {
        const row = document.createElement("div");
        row.className = "logRow";

        const left = document.createElement("div");
        left.className = "logLeft";

        const c1 = document.createElement("span");
        c1.className = "chip";
        c1.textContent = h.key;

        const c2 = document.createElement("span");
        c2.className = "chip";
        c2.textContent = h.code;

        left.appendChild(c1);
        left.appendChild(c2);

        const meta = document.createElement("div");
        meta.className = "logMeta";
        meta.textContent = `${h.time} · keyCode:${h.keyCode}${h.repeat ? " · repeat" : ""}`;

        row.appendChild(left);
        row.appendChild(meta);
        logEl.appendChild(row);
      });
    }

    function exportCSV(){
      const header = ["time","key","code","keyCode","repeat"].join(",");
      const rows = history
        .slice().reverse()
        .map(h => [h.time, safeCSV(h.key), safeCSV(h.code), h.keyCode, h.repeat ? 1 : 0].join(","));
      return [header, ...rows].join("\n");
    }

    function safeCSV(v){
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    async function copyHistory(){
      const lines = history
        .slice().reverse()
        .map(h => `${h.time}\t${h.key}\t${h.code}\tkeyCode:${h.keyCode}${h.repeat ? "\trepeat" : ""}`)
        .join("\n");
      await navigator.clipboard.writeText(lines || "");
    }

    // ===== Focus =====
    document.addEventListener("click", () => {
      app.focus({preventScroll:true});
    });

    // ===== Events =====
    window.addEventListener("keydown", (e) => {
      if (shouldPrevent(e)) e.preventDefault();

      down.add(e.code);
      if (down.size > maxDown) maxDown = down.size;

      const keyEl = byCode(e.code);
      if (keyEl) keyEl.classList.add("pressed");

      bigKeyName.textContent = (e.key && e.key.length === 1) ? e.key.toUpperCase() : (e.key || "—");
      chipKey.textContent = `event.key: ${e.key ?? "—"}`;
      chipCode.textContent = `event.code: ${e.code ?? "—"}`;
      chipKeyCode.textContent = `keyCode: ${e.keyCode ?? "—"}`;

      locEl.textContent = keyLocationName(e.code);
      repEl.textContent = e.repeat ? "да" : "нет";

      downCountEl.textContent = String(down.size);
      maxCountEl.textContent = String(maxDown);

      updateModsFromEvent(e);

      // lock keys
      if (e.code === "CapsLock" || e.code === "NumLock"){
        if (keyEl) keyEl.classList.toggle("sticky", e.getModifierState && e.getModifierState(e.code === "CapsLock" ? "CapsLock" : "NumLock"));
      }

      pushHistory({
        time: toTime(),
        key: e.key ?? "",
        code: e.code ?? "",
        keyCode: e.keyCode ?? "",
        repeat: !!e.repeat
      });
    }, {passive:false});

    window.addEventListener("keyup", (e) => {
      if (shouldPrevent(e)) e.preventDefault();

      down.delete(e.code);
      downCountEl.textContent = String(down.size);

      const keyEl = byCode(e.code);
      if (keyEl) keyEl.classList.remove("pressed");
    }, {passive:false});

    window.addEventListener("blur", () => {
      down.forEach(code => {
        const keyEl = byCode(code);
        if (keyEl) keyEl.classList.remove("pressed");
      });
      down.clear();
      downCountEl.textContent = "0";
    });

    // ===== Buttons =====
    captureBtn.addEventListener("click", () => {
      CAPTURE = !CAPTURE;
      captureBtn.classList.toggle("pillOn", CAPTURE);
      captureBtn.textContent = `Capture: ${CAPTURE ? "ON" : "OFF"}`;
    });

    langBtn.addEventListener("click", () => {
      UI_LANG = (UI_LANG === "ru") ? "en" : "ru";
      langBtn.textContent = UI_LANG.toUpperCase();
      applyKeyLegends();
    });

    osBtn.addEventListener("click", () => {
      UI_OS = (UI_OS === "win") ? "mac" : "win";
      osBtn.textContent = (UI_OS === "mac") ? "Mac" : "Windows";
      applyKeyLegends();
    });

    copyBtn.addEventListener("click", async () => {
      try{
        await copyHistory();
        copyBtn.textContent = "Скопировано ✓";
        setTimeout(()=>copyBtn.textContent="Копировать", 900);
      }catch{
        copyBtn.textContent = "Ошибка";
        setTimeout(()=>copyBtn.textContent="Копировать", 900);
      }
    });

    csvBtn.addEventListener("click", () => {
      const csv = exportCSV();
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "keyboard-history.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener("click", () => {
      history.length = 0;
      renderHistory();
    });

    // ===== PWA install =====
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.hidden = true;
    });

    // ===== Service Worker =====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js")
        .then(() => swStatus.textContent = "Offline cache: ok")
        .catch(() => swStatus.textContent = "Offline cache: error");
    } else {
      swStatus.textContent = "Offline cache: n/a";
    }

    // init
    renderKeyboard();
    renderHistory();
    openDrawer(false);
  </script>
</body>
</html>
