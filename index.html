<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ–Ω–ª–∞–π–Ω: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–∂–∞—Ç—ã—Ö –∫–ª–∞–≤–∏—à, –∏—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π, rollover/ghosting —Ç–µ—Å—Ç. –ù–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä." />
  <meta name="theme-color" content="#0b0b12" />
  <meta property="og:title" content="Keyboard Tester" />
  <meta property="og:description" content="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–∞–≤–∏—à, –ª–æ–≥, rollover/ghosting —Ç–µ—Å—Ç." />
  <meta property="og:type" content="website" />
  <title>Keyboard Tester</title>

  <style>
    :root{
      --bg: #07070d;
      --bg2:#0b0b12;
      --card:#111225;
      --card2:#151738;
      --text:#f6f6fb;
      --muted:#a8abc6;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.06);
      --accent:#6c5ce7;
      --accent2:#a29bff;
      --good:#55efc4;
      --warn:#ffeaa7;
      --bad:#ff7675;
      --shadow: 0 30px 80px rgba(0,0,0,.65);
      --radius: 18px;
      --radius2: 14px;
      --kbd:#0e0f1d;
      --kbd2:#12142a;
      --kbdPressed: rgba(108,92,231,.22);
      --kbdPressedBorder: rgba(162,155,255,.85);
      --kbdText:#eaeafd;
      --kbdMuted:#b6b9d8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    [data-theme="light"]{
      --bg: #f5f6ff;
      --bg2:#edf0ff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#0b0b12;
      --muted:#4c506d;
      --border: rgba(10,10,18,.12);
      --border2: rgba(10,10,18,.08);
      --shadow: 0 18px 55px rgba(20,20,40,.15);
      --kbd:#f3f5ff;
      --kbd2:#eef1ff;
      --kbdPressed: rgba(108,92,231,.16);
      --kbdPressedBorder: rgba(108,92,231,.55);
      --kbdText:#0b0b12;
      --kbdMuted:#3c4160;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(108,92,231,.26), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(162,155,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding: 26px;
    }

    .wrap{
      max-width: 1220px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.2fr);
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 1050px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 45%), var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{ padding: 18px 18px 16px; }
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      padding: 18px 18px 8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 260px;
    }
    .logo{
      width: 40px; height: 40px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, rgba(162,155,255,.35), rgba(108,92,231,.25) 40%, rgba(0,0,0,.2) 78%),
                  rgba(108,92,231,.10);
      border: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight: 800;
      letter-spacing: .02em;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .title h1{
      font-size: 18px;
      font-weight: 760;
      letter-spacing: .02em;
      margin-bottom: 2px;
    }
    .title p{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 560px;
    }

    .controls{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: var(--border); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(108,92,231,.25), rgba(162,155,255,.18));
      border-color: rgba(162,155,255,.35);
    }
    .chip{
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      color: var(--muted);
      display:inline-flex; gap: 6px; align-items:center;
      background: rgba(0,0,0,.12);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 12px rgba(85,239,196,.55);
    }
    .dot.off{ background: var(--warn); box-shadow: 0 0 12px rgba(255,234,167,.45); }

    .grid2{
      display:grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, .95fr);
      gap: 14px;
    }
    @media (max-width: 850px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .panel{
      border: 1px solid var(--border2);
      background: rgba(0,0,0,.12);
      border-radius: var(--radius2);
      padding: 14px;
    }
    [data-theme="light"] .panel{
      background: rgba(10,10,18,.03);
    }

    .kbox{
      border-radius: 16px;
      border: 1px solid var(--border2);
      background: radial-gradient(circle at 25% 10%, rgba(255,255,255,.06), transparent 55%), rgba(0,0,0,.18);
      padding: 14px;
      overflow:hidden;
    }
    [data-theme="light"] .kbox{
      background: radial-gradient(circle at 25% 10%, rgba(10,10,18,.03), transparent 55%), rgba(10,10,18,.02);
    }

    .bigkey{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .bigkey .left{ display:flex; flex-direction:column; gap: 6px; }
    .label{
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .keycap{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 150px;
      min-height: 64px;
      padding: 10px 16px;
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      font-size: 34px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    [data-theme="light"] .keycap{ background: rgba(10,10,18,.04); box-shadow: 0 18px 40px rgba(20,20,40,.10); }
    .keycap.empty{
      font-size: 16px;
      font-weight: 650;
      letter-spacing: .02em;
      text-transform:none;
      color: var(--muted);
    }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){ .meta{ grid-template-columns: 1fr; } }
    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--text);
      max-width: 62%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mods{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
      margin-top: 12px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    .miniKey{
      font-family: var(--mono);
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color: var(--kbdMuted);
      transition: all .12s ease;
    }
    .miniKey.on{
      border-color: var(--kbdPressedBorder);
      background: var(--kbdPressed);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(162,155,255,.35);
    }

    .sectionTitle{
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    /* Virtual keyboard */
    .kbWrap{
      border-radius: 16px;
      border: 1px solid var(--border2);
      background: rgba(0,0,0,.16);
      padding: 12px;
      overflow:auto;
    }
    [data-theme="light"] .kbWrap{ background: rgba(10,10,18,.02); }

    .row{ display:grid; gap: 8px; margin-bottom: 8px; }
    .row:last-child{ margin-bottom: 0; }

    .key{
      position:relative;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 50%), var(--kbd);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--kbdText);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-family: var(--mono);
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      min-width: 44px;
    }
    [data-theme="light"] .key{
      background: linear-gradient(180deg, rgba(10,10,18,.03), transparent 50%), var(--kbd);
      border-color: rgba(10,10,18,.12);
    }
    .key .sub{
      position:absolute;
      right: 8px;
      bottom: 6px;
      font-size: 10px;
      color: var(--kbdMuted);
      opacity: .85;
    }
    .key.pressed{
      background: linear-gradient(180deg, rgba(162,155,255,.22), rgba(108,92,231,.14)), var(--kbd2);
      border-color: var(--kbdPressedBorder);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(108,92,231,.22);
    }

    .row.r1{ grid-template-columns: repeat(14, 1fr); min-width: 860px; }
    .row.r2{ grid-template-columns: 1.2fr repeat(12, 1fr) 1.8fr; min-width: 860px; }
    .row.r3{ grid-template-columns: 1.6fr repeat(12, 1fr) 2.2fr; min-width: 860px; }
    .row.r4{ grid-template-columns: 2.1fr repeat(11, 1fr) 2.7fr; min-width: 860px; }
    .row.r5{ grid-template-columns: 2.7fr repeat(10, 1fr) 3.2fr; min-width: 860px; }
    .row.r6{ grid-template-columns: 1.6fr 1.6fr 1.6fr 6.6fr 1.6fr 1.6fr 1.6fr; min-width: 860px; }

    /* Log */
    .log{
      max-height: 240px;
      overflow:auto;
      border: 1px dashed var(--border2);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,.14);
    }
    [data-theme="light"] .log{ background: rgba(10,10,18,.02); }

    .logRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.04);
    }
    [data-theme="light"] .logRow{ border-bottom: 1px solid rgba(10,10,18,.06); }
    .logRow:last-child{ border-bottom:none; }
    .logLeft{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }
    .pillKey{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.03);
    }
    .logMeta{
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .empty{
      font-size: 13px;
      color: var(--muted);
      padding: 6px 2px;
    }

    .note{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }
    .note b{ color: var(--text); }

    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){ .statGrid{ grid-template-columns: 1fr; } }
    .stat{
      border: 1px solid var(--border2);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    .stat .n{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .02em;
    }
    .stat .t{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .footer{
      margin-top: 10px;
      font-size: 11.5px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .footer a{ color: var(--accent2); text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      display:none;
      gap: 8px;
      align-items:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      z-index: 99;
    }
    [data-theme="light"] .toast{ background: rgba(10,10,18,.78); }

    .toast.show{ display:inline-flex; animation: pop .18s ease; }
    @keyframes pop{ from{ transform: translateX(-50%) translateY(8px); opacity:0 } to{ transform: translateX(-50%) translateY(0); opacity:1 } }

    .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <!-- MAIN -->
    <section class="card" id="mainCard" tabindex="0" aria-label="Keyboard tester">
      <div class="header">
        <div class="brand">
          <div class="logo">K</div>
          <div class="title">
            <h1 id="uiTitle">–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</h1>
            <p id="uiSub">
              –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–∞–≤–∏—à, –∏—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π –∏ —Ç–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (rollover/ghosting).
              –ù–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
            </p>
          </div>
        </div>

        <div class="controls">
          <span class="chip" title="–°—Ç–∞—Ç—É—Å">
            <span class="dot" id="dot"></span>
            <span id="uiLive">Live</span>
          </span>

          <button class="btn primary" id="btnCapture" title="Capture Mode ‚Äî –ª–æ–≤–∏—Ç—å –∫–ª–∞–≤–∏—à–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–∞">
            <span id="uiCapture">Capture: ON</span>
          </button>

          <button class="btn" id="btnLang" title="Language / –Ø–∑—ã–∫">RU</button>
          <button class="btn" id="btnTheme" title="Theme">üåô</button>
          <button class="btn" id="btnShare" title="Copy site link">üîó <span id="uiShare">–°—Å—ã–ª–∫–∞</span></button>
        </div>
      </div>

      <div class="inner">
        <div class="grid2">
          <!-- LEFT: Live -->
          <div class="kbox">
            <div class="bigkey">
              <div class="left">
                <div class="label" id="uiCurrentKeyLabel">–¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏—à–∞</div>
                <div class="keycap empty" id="bigKey">–ù–∞–∂–º–∏ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É</div>
              </div>

              <div class="panel" style="min-width:260px; max-width:360px;">
                <div class="sectionTitle">
                  <span id="uiQuickHelpTitle">–ë—ã—Å—Ç—Ä–æ</span>
                </div>
                <p class="note" id="uiQuickHelp">
                  –ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∏ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏. –î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π –∑–∞–∂–∏–º–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫.
                  –ï—Å–ª–∏ –º–µ—à–∞—é—Ç –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ö–æ—Ç–∫–µ–∏ ‚Äî –≤–∫–ª—é—á–∏/–≤—ã–∫–ª—é—á–∏ <b>Capture Mode</b>.
                </p>
              </div>
            </div>

            <div class="meta" aria-label="Keyboard event fields">
              <div class="metaRow"><span>event.key</span><span class="badge" id="mKey">‚Äî</span></div>
              <div class="metaRow"><span>event.code</span><span class="badge" id="mCode">‚Äî</span></div>
              <div class="metaRow"><span>keyCode</span><span class="badge" id="mKeyCode">‚Äî</span></div>
              <div class="metaRow"><span id="uiLocation">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</span><span class="badge" id="mLoc">‚Äî</span></div>
            </div>

            <div class="mods">
              <span id="uiMods">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</span>
              <span class="miniKey" id="modCtrl">Ctrl</span>
              <span class="miniKey" id="modAlt">Alt</span>
              <span class="miniKey" id="modShift">Shift</span>
              <span class="miniKey" id="modMeta">Win / ‚åò</span>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="sectionTitle">
                <span id="uiPressedNow">–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã</span>
                <button class="btn" id="btnClearPressed" title="Clear pressed (if window lost focus)">
                  <span id="uiReset">–°–±—Ä–æ—Å</span>
                </button>
              </div>
              <div class="note" id="pressedNow">‚Äî</div>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="sectionTitle">
                <span id="uiRollover">Rollover / Ghosting —Ç–µ—Å—Ç</span>
              </div>
              <div class="statGrid">
                <div class="stat">
                  <div class="n" id="simulNow">0</div>
                  <div class="t" id="uiSimulNow">–°–µ–π—á–∞—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</div>
                </div>
                <div class="stat">
                  <div class="n" id="simulMax">0</div>
                  <div class="t" id="uiSimulMax">–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–µ—Å—Å–∏—é</div>
                </div>
              </div>
              <div style="height:10px"></div>
              <p class="note" id="uiRolloverHint">
                –ó–∞–∂–º–∏ –º–Ω–æ–≥–æ –±—É–∫–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <b>ASDFJKL;</b>) –∏ —Å–º–æ—Ç—Ä–∏ —Å—á—ë—Ç—á–∏–∫.
                –ï—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∞–≤–∏—à–∏ ¬´–ø—Ä–æ–ø–∞–¥–∞—é—Ç¬ª ‚Äî —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ghosting).
              </p>
            </div>
          </div>

          <!-- RIGHT: Virtual keyboard + Log -->
          <div class="kbox">
            <div class="sectionTitle">
              <span id="uiVisualKeyboard">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞</span>
              <span class="chip" title="Tip"><span class="dot off" id="focusDot"></span><span id="uiFocus">–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å</span></span>
            </div>

            <div class="kbWrap" id="kb" aria-label="Virtual keyboard (ANSI US layout)">
              <div class="row r1">
                <div class="key" data-code="Escape">Esc<div class="sub">Esc</div></div>
                <div class="key" data-code="F1">F1</div>
                <div class="key" data-code="F2">F2</div>
                <div class="key" data-code="F3">F3</div>
                <div class="key" data-code="F4">F4</div>
                <div class="key" data-code="F5">F5</div>
                <div class="key" data-code="F6">F6</div>
                <div class="key" data-code="F7">F7</div>
                <div class="key" data-code="F8">F8</div>
                <div class="key" data-code="F9">F9</div>
                <div class="key" data-code="F10">F10</div>
                <div class="key" data-code="F11">F11</div>
                <div class="key" data-code="F12">F12</div>
                <div class="key" data-code="PrintScreen">PrtSc</div>
              </div>

              <div class="row r2">
                <div class="key" data-code="Backquote">`<div class="sub">~</div></div>
                <div class="key" data-code="Digit1">1<div class="sub">!</div></div>
                <div class="key" data-code="Digit2">2<div class="sub">@</div></div>
                <div class="key" data-code="Digit3">3<div class="sub">#</div></div>
                <div class="key" data-code="Digit4">4<div class="sub">$</div></div>
                <div class="key" data-code="Digit5">5<div class="sub">%</div></div>
                <div class="key" data-code="Digit6">6<div class="sub">^</div></div>
                <div class="key" data-code="Digit7">7<div class="sub">&</div></div>
                <div class="key" data-code="Digit8">8<div class="sub">*</div></div>
                <div class="key" data-code="Digit9">9<div class="sub">(</div></div>
                <div class="key" data-code="Digit0">0<div class="sub">)</div></div>
                <div class="key" data-code="Minus">-<div class="sub">_</div></div>
                <div class="key" data-code="Equal">=<div class="sub">+</div></div>
                <div class="key" data-code="Backspace">Backspace</div>
              </div>

              <div class="row r3">
                <div class="key" data-code="Tab">Tab</div>
                <div class="key" data-code="KeyQ">Q</div>
                <div class="key" data-code="KeyW">W</div>
                <div class="key" data-code="KeyE">E</div>
                <div class="key" data-code="KeyR">R</div>
                <div class="key" data-code="KeyT">T</div>
                <div class="key" data-code="KeyY">Y</div>
                <div class="key" data-code="KeyU">U</div>
                <div class="key" data-code="KeyI">I</div>
                <div class="key" data-code="KeyO">O</div>
                <div class="key" data-code="KeyP">P</div>
                <div class="key" data-code="BracketLeft">[<div class="sub">{</div></div>
                <div class="key" data-code="BracketRight">]<div class="sub">}</div></div>
                <div class="key" data-code="Backslash">\ <div class="sub">|</div></div>
              </div>

              <div class="row r4">
                <div class="key" data-code="CapsLock">Caps</div>
                <div class="key" data-code="KeyA">A</div>
                <div class="key" data-code="KeyS">S</div>
                <div class="key" data-code="KeyD">D</div>
                <div class="key" data-code="KeyF">F</div>
                <div class="key" data-code="KeyG">G</div>
                <div class="key" data-code="KeyH">H</div>
                <div class="key" data-code="KeyJ">J</div>
                <div class="key" data-code="KeyK">K</div>
                <div class="key" data-code="KeyL">L</div>
                <div class="key" data-code="Semicolon">;<div class="sub">:</div></div>
                <div class="key" data-code="Quote">'<div class="sub">"</div></div>
                <div class="key" data-code="Enter">Enter</div>
              </div>

              <div class="row r5">
                <div class="key" data-code="ShiftLeft">Shift</div>
                <div class="key" data-code="KeyZ">Z</div>
                <div class="key" data-code="KeyX">X</div>
                <div class="key" data-code="KeyC">C</div>
                <div class="key" data-code="KeyV">V</div>
                <div class="key" data-code="KeyB">B</div>
                <div class="key" data-code="KeyN">N</div>
                <div class="key" data-code="KeyM">M</div>
                <div class="key" data-code="Comma">,<div class="sub">&lt;</div></div>
                <div class="key" data-code="Period">.<div class="sub">&gt;</div></div>
                <div class="key" data-code="Slash">/<div class="sub">?</div></div>
                <div class="key" data-code="ShiftRight">Shift</div>
              </div>

              <div class="row r6">
                <div class="key" data-code="ControlLeft">Ctrl</div>
                <div class="key" data-code="MetaLeft">Win</div>
                <div class="key" data-code="AltLeft">Alt</div>
                <div class="key" data-code="Space">Space</div>
                <div class="key" data-code="AltRight">Alt</div>
                <div class="key" data-code="MetaRight">Win</div>
                <div class="key" data-code="ControlRight">Ctrl</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="panel">
              <div class="sectionTitle">
                <span id="uiHistory">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π</span>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn" id="btnCopy"><span id="uiCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span></button>
                  <button class="btn" id="btnCSV"><span id="uiExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</span></button>
                  <button class="btn" id="btnClear"><span id="uiClear">–û—á–∏—Å—Ç–∏—Ç—å</span></button>
                </div>
              </div>

              <div class="log" id="log">
                <div class="empty" id="logEmpty">–°–¥–µ–ª–∞–π –ø–∞—Ä—É –Ω–∞–∂–∞—Ç–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div>
              </div>

              <div class="footer">
                <span id="uiPrivacy">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</span>
                <span><a href="#" id="focusLink">Focus</a> ¬∑ <a href="#" id="topLink">Top</a></span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- SIDE -->
    <aside class="card">
      <div class="inner">
        <div class="sectionTitle"><span id="uiGuideTitle">–ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</span></div>
        <p class="note" id="uiGuideText">
          <b>–î–ª—è –æ–±—ã—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏</b>: –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏ –∏ —Å–º–æ—Ç—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–ø—Ä–∞–≤–∞.<br/>
          <b>–î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π</b>: –∑–∞–∂–∏–º–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫ ‚Äî —Å–ø–∏—Å–æ–∫ ‚Äú–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã‚Äù –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.<br/>
          <b>–î–ª—è ghosting —Ç–µ—Å—Ç–∞</b>: —É–¥–µ—Ä–∂–∏–≤–∞–π 6‚Äì10 –∫–ª–∞–≤–∏—à –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ (–±—É–∫–≤—ã/—Ä—è–¥ —Ü–∏—Ñ—Ä) –∏ —Å–º–æ—Ç—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
        </p>

        <div style="height:14px"></div>

        <div class="sectionTitle"><span id="uiFieldsTitle">–ß—Ç–æ –∑–Ω–∞—á–∞—Ç –ø–æ–ª—è</span></div>
        <ul class="note" style="line-height:1.55; padding-left: 18px;" id="uiFieldsList">
          <li><b>event.key</b> ‚Äî ‚Äú—Å–∏–º–≤–æ–ª/–Ω–∞–∑–≤–∞–Ω–∏–µ‚Äù (Enter, a, √º‚Ä¶)</li>
          <li><b>event.code</b> ‚Äî ‚Äú—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ‚Äù (–≤–∞–∂–Ω–æ –¥–ª—è –∏–≥—Ä)</li>
          <li><b>keyCode</b> ‚Äî —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</li>
          <li><b>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b> ‚Äî –ª–µ–≤–∞—è/–ø—Ä–∞–≤–∞—è/numPad</li>
        </ul>

        <div style="height:14px"></div>

        <div class="sectionTitle"><span id="uiProTitle">–§–∏—à–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞</span></div>
        <ul class="note" style="line-height:1.55; padding-left: 18px;" id="uiProList">
          <li>–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–∞–≤–∏—à + –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π</li>
          <li>Rollover/ghosting —Ç–µ—Å—Ç</li>
          <li>–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ CSV</li>
          <li>RU/EN, Light/Dark, Capture mode</li>
        </ul>

        <div style="height:14px"></div>

        <div class="sectionTitle"><span id="uiTipTitle">–õ–∞–π—Ñ—Ö–∞–∫</span></div>
        <p class="note" id="uiTipText">
          –ï—Å–ª–∏ –∫–ª–∞–≤–∏—à–∏ ‚Äú–∑–∞–ª–∏–ø–ª–∏‚Äù –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–∫–Ω–∞ ‚Äî –Ω–∞–∂–º–∏ <b>–°–±—Ä–æ—Å</b> –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∑–∞—Ç–µ–º –æ—Ç–ø—É—Å—Ç–∏ –≤—Å—ë.
        </p>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span>‚úÖ</span><span id="toastText">–ì–æ—Ç–æ–≤–æ</span>
  </div>

  <div class="sr" id="srStatus" aria-live="polite"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const app = $("app");
  const mainCard = $("mainCard");

  const bigKey = $("bigKey");
  const mKey = $("mKey");
  const mCode = $("mCode");
  const mKeyCode = $("mKeyCode");
  const mLoc = $("mLoc");

  const modCtrl = $("modCtrl");
  const modAlt = $("modAlt");
  const modShift = $("modShift");
  const modMeta = $("modMeta");

  const pressedNow = $("pressedNow");
  const btnClearPressed = $("btnClearPressed");

  const simulNow = $("simulNow");
  const simulMax = $("simulMax");

  const log = $("log");
  const logEmpty = $("logEmpty");

  const btnClear = $("btnClear");
  const btnCopy = $("btnCopy");
  const btnCSV = $("btnCSV");
  const btnShare = $("btnShare");
  const btnTheme = $("btnTheme");
  const btnLang = $("btnLang");
  const btnCapture = $("btnCapture");

  const dot = $("dot");
  const focusDot = $("focusDot");

  const toast = $("toast");
  const toastText = $("toastText");
  const srStatus = $("srStatus");

  const focusLink = $("focusLink");
  const topLink = $("topLink");

  const keys = Array.from(document.querySelectorAll("[data-code]"));
  const keyByCode = new Map(keys.map(k => [k.dataset.code, k]));

  // State
  let captureMode = true;
  let lang = localStorage.getItem("kb_lang") || "ru";
  let theme = localStorage.getItem("kb_theme") || "dark";
  const pressed = new Set(); // store codes
  const logData = [];
  const LOG_LIMIT = 40;
  let maxSimul = 0;

  const i18n = {
    ru: {
      title: "–¢–µ—Å—Ç–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã",
      sub: "–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–∞–≤–∏—à, –∏—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π –∏ —Ç–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (rollover/ghosting). –ù–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.",
      live: "Live",
      captureOn: "Capture: ON",
      captureOff: "Capture: OFF",
      share: "–°—Å—ã–ª–∫–∞",
      currentKey: "–¢–µ–∫—É—â–∞—è –∫–ª–∞–≤–∏—à–∞",
      quick: "–ë—ã—Å—Ç—Ä–æ",
      quickHelp: "–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∏ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏. –î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π –∑–∞–∂–∏–º–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫. –ï—Å–ª–∏ –º–µ—à–∞—é—Ç –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ö–æ—Ç–∫–µ–∏ ‚Äî –≤–∫–ª—é—á–∏/–≤—ã–∫–ª—é—á–∏ Capture Mode.",
      location: "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
      mods: "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:",
      pressedNow: "–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã",
      reset: "–°–±—Ä–æ—Å",
      rollover: "Rollover / Ghosting —Ç–µ—Å—Ç",
      simulNow: "–°–µ–π—á–∞—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ",
      simulMax: "–ú–∞–∫—Å–∏–º—É–º –∑–∞ —Å–µ—Å—Å–∏—é",
      rolloverHint: "–ó–∞–∂–º–∏ –º–Ω–æ–≥–æ –±—É–∫–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ASDFJKL;) –∏ —Å–º–æ—Ç—Ä–∏ —Å—á—ë—Ç—á–∏–∫. –ï—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∞–≤–∏—à–∏ ¬´–ø—Ä–æ–ø–∞–¥–∞—é—Ç¬ª ‚Äî —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ghosting).",
      visual: "–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞",
      needFocus: "–ù—É–∂–µ–Ω —Ñ–æ–∫—É—Å",
      history: "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∂–∞—Ç–∏–π",
      copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      export: "–≠–∫—Å–ø–æ—Ä—Ç CSV",
      clear: "–û—á–∏—Å—Ç–∏—Ç—å",
      empty: "–°–¥–µ–ª–∞–π –ø–∞—Ä—É –Ω–∞–∂–∞—Ç–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.",
      privacy: "–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å: –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.",
      guideTitle: "–ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å",
      guideText: "<b>–î–ª—è –æ–±—ã—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏</b>: –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–π –∫–ª–∞–≤–∏—à–∏ –∏ —Å–º–æ—Ç—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–ø—Ä–∞–≤–∞.<br/><b>–î–ª—è —Å–æ—á–µ—Ç–∞–Ω–∏–π</b>: –∑–∞–∂–∏–º–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫ ‚Äî —Å–ø–∏—Å–æ–∫ ‚Äú–°–µ–π—á–∞—Å –∑–∞–∂–∞—Ç—ã‚Äù –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.<br/><b>–î–ª—è ghosting —Ç–µ—Å—Ç–∞</b>: —É–¥–µ—Ä–∂–∏–≤–∞–π 6‚Äì10 –∫–ª–∞–≤–∏—à –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ (–±—É–∫–≤—ã/—Ä—è–¥ —Ü–∏—Ñ—Ä) –∏ —Å–º–æ—Ç—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.",
      fieldsTitle: "–ß—Ç–æ –∑–Ω–∞—á–∞—Ç –ø–æ–ª—è",
      proTitle: "–§–∏—à–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞",
      tipTitle: "–õ–∞–π—Ñ—Ö–∞–∫",
      tipText: "–ï—Å–ª–∏ –∫–ª–∞–≤–∏—à–∏ ‚Äú–∑–∞–ª–∏–ø–ª–∏‚Äù –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–∫–Ω–∞ ‚Äî –Ω–∞–∂–º–∏ <b>–°–±—Ä–æ—Å</b> –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∑–∞—Ç–µ–º –æ—Ç–ø—É—Å—Ç–∏ –≤—Å—ë.",
      toastCopied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ",
      toastLink: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ",
      toastCSV: "CSV —Å–∫–∞—á–∞–Ω ‚úÖ",
      toastCleared: "–û—á–∏—â–µ–Ω–æ ‚úÖ",
      toastReset: "–°–±—Ä–æ—à–µ–Ω–æ ‚úÖ"
    },
    en: {
      title: "Keyboard Tester",
      sub: "Key highlighting, event history and rollover/ghosting test. No data is sent anywhere ‚Äî everything runs locally in your browser.",
      live: "Live",
      captureOn: "Capture: ON",
      captureOff: "Capture: OFF",
      share: "Link",
      currentKey: "Current key",
      quick: "Quick help",
      quickHelp: "Click the card and press any keys. Hold multiple keys for combos. If browser shortcuts interfere ‚Äî toggle Capture Mode.",
      location: "Location",
      mods: "Modifiers:",
      pressedNow: "Pressed now",
      reset: "Reset",
      rollover: "Rollover / Ghosting test",
      simulNow: "Simultaneous now",
      simulMax: "Session max",
      rolloverHint: "Hold many keys (e.g., ASDFJKL;) and watch the counter. If some keys disappear ‚Äî that‚Äôs keyboard ghosting / rollover limits.",
      visual: "Visual keyboard",
      needFocus: "Need focus",
      history: "History",
      copy: "Copy",
      export: "Export CSV",
      clear: "Clear",
      empty: "Press a few keys ‚Äî they will appear here.",
      privacy: "Privacy: nothing is sent to a server.",
      guideTitle: "How to use",
      guideText: "<b>Basic check</b>: press keys and watch highlights.<br/><b>Combos</b>: hold multiple keys ‚Äî ‚ÄúPressed now‚Äù shows what is truly held.<br/><b>Ghosting</b>: hold 6‚Äì10 keys in the same area and watch max.",
      fieldsTitle: "Field meanings",
      proTitle: "Product features",
      tipTitle: "Tip",
      tipText: "If keys look stuck after switching tabs ‚Äî press <b>Reset</b> or click the page and release everything.",
      toastCopied: "Copied ‚úÖ",
      toastLink: "Link copied ‚úÖ",
      toastCSV: "CSV downloaded ‚úÖ",
      toastCleared: "Cleared ‚úÖ",
      toastReset: "Reset ‚úÖ"
    }
  };

  function setText(id, text){ const el = $(id); if(el) el.textContent = text; }
  function setHTML(id, html){ const el = $(id); if(el) el.innerHTML = html; }

  function applyLang(){
    const t = i18n[lang];
    setText("uiTitle", t.title);
    setText("uiSub", t.sub);
    setText("uiLive", t.live);
    setText("uiCurrentKeyLabel", t.currentKey);
    setText("uiQuickHelpTitle", t.quick);
    setHTML("uiQuickHelp", t.quickHelp);
    setText("uiLocation", t.location);
    setText("uiMods", t.mods);
    setText("uiPressedNow", t.pressedNow);
    setText("uiReset", t.reset);
    setText("uiRollover", t.rollover);
    setText("uiSimulNow", t.simulNow);
    setText("uiSimulMax", t.simulMax);
    setHTML("uiRolloverHint", t.rolloverHint);
    setText("uiVisualKeyboard", t.visual);
    setText("uiFocus", t.needFocus);
    setText("uiHistory", t.history);
    setText("uiCopy", t.copy);
    setText("uiExport", t.export);
    setText("uiClear", t.clear);
    setText("logEmpty", t.empty);
    setText("uiPrivacy", t.privacy);
    setText("uiGuideTitle", t.guideTitle);
    setHTML("uiGuideText", t.guideText);
    setText("uiFieldsTitle", t.fieldsTitle);
    setText("uiProTitle", t.proTitle);
    setText("uiTipTitle", t.tipTitle);
    setHTML("uiTipText", t.tipText);
    $("btnLang").textContent = lang.toUpperCase();
    updateCaptureBtn();
  }

  function applyTheme(){
    document.documentElement.setAttribute("data-theme", theme);
    btnTheme.textContent = theme === "dark" ? "üåô" : "‚òÄÔ∏è";
    localStorage.setItem("kb_theme", theme);
  }

  function toastShow(text){
    toastText.textContent = text;
    toast.classList.add("show");
    srStatus.textContent = text;
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
  }

  function updateCaptureBtn(){
    const t = i18n[lang];
    setText("uiCapture", captureMode ? t.captureOn : t.captureOff);
    dot.classList.toggle("off", !captureMode);
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function locText(loc){
    if(lang === "en"){
      if(loc === 1) return "Left";
      if(loc === 2) return "Right";
      if(loc === 3) return "Numpad";
      return "Standard";
    } else {
      if(loc === 1) return "–õ–µ–≤–∞—è";
      if(loc === 2) return "–ü—Ä–∞–≤–∞—è";
      if(loc === 3) return "Numpad";
      return "–û–±—ã—á–Ω–æ–µ";
    }
  }

  function setFocusState(hasFocus){
    focusDot.classList.toggle("off", !hasFocus);
    focusDot.style.background = hasFocus ? "var(--good)" : "var(--warn)";
    focusDot.style.boxShadow = hasFocus ? "0 0 12px rgba(85,239,196,.55)" : "0 0 12px rgba(255,234,167,.45)";
  }

  function setMods(e){
    modCtrl.classList.toggle("on", !!e.ctrlKey);
    modAlt.classList.toggle("on", !!e.altKey);
    modShift.classList.toggle("on", !!e.shiftKey);
    modMeta.classList.toggle("on", !!e.metaKey);
  }

  function updatePressedText(){
    if(!pressed.size){
      pressedNow.textContent = "‚Äî";
      simulNow.textContent = "0";
      return;
    }
    const list = Array.from(pressed).sort();
    pressedNow.textContent = list.join(" + ");
    simulNow.textContent = String(pressed.size);
    if(pressed.size > maxSimul){
      maxSimul = pressed.size;
      simulMax.textContent = String(maxSimul);
    }
  }

  function highlight(code, on){
    const el = keyByCode.get(code);
    if(el) el.classList.toggle("pressed", on);
  }

  function setMain(e){
    const display = (e.key === " ") ? "Space" : e.key;
    bigKey.textContent = display;
    bigKey.classList.remove("empty");

    mKey.textContent = String(e.key);
    mCode.textContent = String(e.code);
    mKeyCode.textContent = String(e.keyCode);
    mLoc.textContent = locText(e.location);

    setMods(e);
  }

  function addLog(e){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    const time = `${hh}:${mm}:${ss}`;

    const item = {
      time,
      key: (e.key === " ") ? "Space" : e.key,
      code: e.code,
      keyCode: e.keyCode,
      mods: [
        e.ctrlKey ? "Ctrl" : null,
        e.altKey ? "Alt" : null,
        e.shiftKey ? "Shift" : null,
        e.metaKey ? "Win/‚åò" : null
      ].filter(Boolean).join(" + ") || "‚Äî",
      type: e.type
    };

    logData.unshift(item);
    if(logData.length > LOG_LIMIT) logData.length = LOG_LIMIT;
    renderLog();
  }

  function renderLog(){
    if(!logData.length){
      log.innerHTML = `<div class="empty">${escapeHtml(i18n[lang].empty)}</div>`;
      return;
    }
    log.innerHTML = logData.map(x => `
      <div class="logRow">
        <div class="logLeft">
          <span class="pillKey">${escapeHtml(x.key)}</span>
          <span class="pillKey">${escapeHtml(x.code)}</span>
        </div>
        <div class="logMeta">${escapeHtml(x.time)} ¬∑ keyCode:${escapeHtml(String(x.keyCode))} ¬∑ ${escapeHtml(x.mods)}</div>
      </div>
    `).join("");
  }

  function maybePreventDefaults(e){
    if(!captureMode) return;

    // Prevent scrolling / page jump keys (still allows most browser shortcuts if user insists)
    const block = new Set([" ", "Spacebar", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "PageUp", "PageDown", "Home", "End"]);
    if(block.has(e.key)) e.preventDefault();

    // If user is holding Ctrl/Meta, do NOT block (so they can refresh/close tab if needed)
    if(e.ctrlKey || e.metaKey) return;

    // Prevent accidental focus shift with Tab inside tester
    if(e.key === "Tab") e.preventDefault();
  }

  function onDown(e){
    setFocusState(document.activeElement === mainCard);
    if(document.activeElement !== mainCard) return;

    maybePreventDefaults(e);
    setMain(e);

    const code = e.code || String(e.keyCode) || e.key;
    if(!pressed.has(code)){
      pressed.add(code);
      highlight(code, true);
      updatePressedText();
    }
    if(!e.repeat) addLog(e);
  }

  function onUp(e){
    if(document.activeElement !== mainCard) return;

    const code = e.code || String(e.keyCode) || e.key;
    if(pressed.has(code)){
      pressed.delete(code);
      highlight(code, false);
      updatePressedText();
    }
    setMods(e);
  }

  function resetAll(){
    for(const code of pressed) highlight(code, false);
    pressed.clear();
    updatePressedText();
    modCtrl.classList.remove("on");
    modAlt.classList.remove("on");
    modShift.classList.remove("on");
    modMeta.classList.remove("on");
    toastShow(i18n[lang].toastReset);
  }

  function copyText(txt){
    return navigator.clipboard.writeText(txt);
  }

  function exportCSV(){
    const rows = [["time","type","key","code","keyCode","mods"]];
    for(const x of logData.slice().reverse()){
      rows.push([x.time, x.type, x.key, x.code, String(x.keyCode), x.mods]);
    }
    const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "keyboard-history.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    toastShow(i18n[lang].toastCSV);
  }

  // UI bindings
  btnTheme.addEventListener("click", () => {
    theme = (theme === "dark") ? "light" : "dark";
    applyTheme();
  });

  btnLang.addEventListener("click", () => {
    lang = (lang === "ru") ? "en" : "ru";
    localStorage.setItem("kb_lang", lang);
    applyLang();
    renderLog();
  });

  btnCapture.addEventListener("click", () => {
    captureMode = !captureMode;
    updateCaptureBtn();
  });

  btnClearPressed.addEventListener("click", resetAll);

  btnClear.addEventListener("click", () => {
    logData.length = 0;
    renderLog();
    toastShow(i18n[lang].toastCleared);
  });

  btnCopy.addEventListener("click", async () => {
    const lines = logData.slice().reverse().map(x => `${x.time}\t${x.key}\t${x.code}\t${x.keyCode}\t${x.mods}`);
    const txt = lines.join("\n") || "";
    try{
      await copyText(txt);
      toastShow(i18n[lang].toastCopied);
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toastShow(i18n[lang].toastCopied);
    }
  });

  btnCSV.addEventListener("click", exportCSV);

  btnShare.addEventListener("click", async () => {
    const url = location.href.split("#")[0];
    try{
      await copyText(url);
      toastShow(i18n[lang].toastLink);
    }catch{
      toastShow(url);
    }
  });

  focusLink.addEventListener("click", (e) => { e.preventDefault(); mainCard.focus({preventScroll:true}); });
  topLink.addEventListener("click", (e) => { e.preventDefault(); window.scrollTo({top:0, behavior:"smooth"}); });

  // Focus behavior
  mainCard.addEventListener("click", () => mainCard.focus({preventScroll:true}));
  window.addEventListener("focus", () => setFocusState(document.activeElement === mainCard));
  window.addEventListener("blur", () => { setFocusState(false); resetAll(); });

  // Key listeners
  window.addEventListener("keydown", onDown, {passive:false});
  window.addEventListener("keyup", onUp);

  // Init
  applyTheme();
  applyLang();
  renderLog();
  setFocusState(false);
  updateCaptureBtn();
  mainCard.focus({preventScroll:true});

})();
</script>
</body>
</html>
